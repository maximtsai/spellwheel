const DECAY=45e-6,STATIC=.0054,MIN_VEL=1e-4,ENABLE_KEYBOARD=!0;class MagicCircle{constructor(e,t,i){this.scene=e,this.reset(t,i),this.buildCircles(t,i,e),this.createTimeStopObjs(),this.setupKeyPresses(e),this.castDisabled=!1,this.bufferedCastAvailable=!1,this.forcingAlignment=!1,this.outerDragDisabled=!1,this.innerDragDisabled=!1,this.disableSpellDescDisplay=!1,this.elementsAnimArray=[],this.embodimentsAnimArray=[],this.tempRotObjs=[],this.tempLockRot=0,this.lastDragTime=0,this.prevDragAngleDiff=null,this.storedDragAngleDiff=0,this.dScaleAccumulate=0,this.draggedDuration=0,this.preventRotDecay=0,this.lastPlayedClickTime=0,this.subscriptions=[messageBus.subscribe("attackLaunched",this.attackLaunched.bind(this)),messageBus.subscribe("manualSetTimeSlowRatio",this.manualSetTimeSlowRatio.bind(this)),messageBus.subscribe("statusesTicked",this.handleStatusesTicked.bind(this)),messageBus.subscribe("playerAddDelayedDamage",this.addDelayedDamage.bind(this)),messageBus.subscribe("playerReduceDelayedDamage",this.reduceDelayedDamage.bind(this)),messageBus.subscribe("enableVoidArm",this.enableVoidArm.bind(this)),messageBus.subscribe("setTempRotObjs",this.setTempRotObjs.bind(this)),messageBus.subscribe("manualResetElements",this.manualResetElements.bind(this)),messageBus.subscribe("manualResetEmbodiments",this.manualResetEmbodiments.bind(this)),messageBus.subscribe("inflictVoidBurn",this.applyVoidBurn.bind(this)),messageBus.subscribe("startVoidForm",this.handleVoidForm.bind(this)),messageBus.subscribe("stopVoidForm",this.clearVoidForm.bind(this)),messageBus.subscribe("selfClearEffect",this.clearMindForm.bind(this)),messageBus.subscribe("enemyHasDied",this.clearEffects.bind(this)),messageBus.subscribe("enemyHasDied",this.cancelTimeSlow.bind(this)),messageBus.subscribe("selfClearStatuses",this.clearEffects.bind(this)),messageBus.subscribe("applyMindBurn",this.applyMindBurn.bind(this)),messageBus.subscribe("playerDied",this.playerDied.bind(this)),messageBus.subscribe("playerRevived",this.playerRevived.bind(this)),messageBus.subscribe("highlightRunes",this.highlightRunes.bind(this)),messageBus.subscribe("unhighlightRunes",this.unhighlightRunes.bind(this)),messageBus.subscribe("showCircleShadow",this.showCircleShadow.bind(this)),messageBus.subscribe("setCircleShadow",this.setCircleShadow.bind(this)),messageBus.subscribe("refreshHoverDisplay",this.refreshHoverText.bind(this))],updateManager.addFunction(this.update.bind(this))}setupKeyPresses(e){this.keyW=e.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W),this.keyA=e.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A),this.keyS=e.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S),this.keyD=e.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D),this.keyQ=e.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Q),this.keyE=e.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.E),this.keyP=e.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.P),this.keyLeft=e.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT),this.keyRight=e.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT),this.keyUp=e.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP),this.keyDown=e.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.DOWN),this.keyEnter=e.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER),this.keySpace=e.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE),this.keyEscape=e.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ESC)}update(e){this.lastDragTime>15?gameVars.playerNotMoved=!0:gameVars.playerNotMoved=!1,this.handleTimeSlow(e),this.lastDragTime+=e;let t=gameVars.mouseposx-this.x,i=gameVars.mouseposy-this.y,s=Math.sqrt(t*t+i*i);if(this.setFrameLazy(this.castButton,this.altString+"cast_normal.png"),globalObjects.player.setCastTextAlpha(.65),this.setFrameLazy(this.innerCircle,this.altString+"element_normal.png"),this.setFrameLazy(this.outerCircle,this.altString+"usage_normal.png"),this.manualDisabled&&(this.dragArrow.visible=!1,this.dragCircle.visible=!1),this.delayedDamage>this.delayedDamageBase){let a=Math.sqrt(6*Math.max(0,this.delayedDamage-this.delayedDamageBase));this.delayedDamage>1.25*this.delayedDamageBase&&(this.delayDamageSandFull.x+=Math.random()*a*.03),this.delayDamageSandFull.x=this.delayDamageSandFull.origX+(this.delayDamageSandFull.origX-this.delayDamageSandFull.x)*.75,this.delayDamageSandFull.x+=Math.random()*(.12*a+.5),this.delayDamageHourglass.x=this.delayDamageSandFull.x}else this.delayDamageSandFull.x=this.delayDamageSandFull.origX,this.delayDamageHourglass.x=this.delayDamageSandFull.x;if(!this.recentSkipped&&(this.keyEnter.isDown||this.keySpace.isDown||this.keyEscape.isDown)){let l=globalObjects.bannerTextManager.continueDialog();globalObjects.currentEnemy&&globalObjects.currentEnemy.dieClickBlocker&&!globalObjects.currentEnemy.dieClickBlocker.isDestroyed&&globalObjects.currentEnemy.dieClickBlocker.onMouseUpFunc&&(globalObjects.currentEnemy.dieClickBlocker.clickMouseUp(),l=!0),globalObjects.lvlCloseButton&&!globalObjects.lvlCloseButton.isDestroyed&&globalObjects.lvlCloseButton.onMouseUpFunc&&(globalObjects.lvlCloseButton.clickMouseUp(),l=!0),this.recentSkipped=!0,this.keyEscape.isDown&&(globalObjects.encyclopedia.canClose&&(l=!0,messageBus.publish("cancelScreen")),globalObjects.options.canClose?messageBus.publish("cancelScreen"):l?messageBus.publish("cancelScreen"):messageBus.publish("toggleCancelScreen"))}else!this.recentSkipped&&this.keyP.isDown?(this.recentSkipped=!0,messageBus.publish("toggleCancelScreen")):!this.recentSkipped||this.keyEnter.isDown||this.keySpace.isDown||this.keyEscape.isDown||this.keyP.isDown||(this.recentSkipped=!1);if(this.outerDragDisabled||this.innerDragDisabled||this.manualDisabled||(this.keyA.isDown||this.keyDown.isDown?this.keyboardRotateInner>-.25?(this.keyboardRotateInner=-1.46,this.keyboardRotateInnerDeadTime=this.defaultDeadTime):this.keyboardRotateInnerDeadTime>0?(this.keyboardRotateInnerDeadTime-=e,this.keyboardRotateInner=-.4):this.keyboardRotateInner=-1:this.keyD.isDown||this.keyUp.isDown?this.keyboardRotateInner<.25?(this.keyboardRotateInner=1.46,this.keyboardRotateInnerDeadTime=this.defaultDeadTime):this.keyboardRotateInnerDeadTime>0?(this.keyboardRotateInnerDeadTime-=e,this.keyboardRotateInner=.4):this.keyboardRotateInner=1:this.keyboardRotateInner=0,this.keyW.isDown||this.keyRight.isDown||this.keyE.isDown?this.keyboardRotateOuter<.25?(this.keyboardRotateOuter=1.41,this.keyboardRotateOuterDeadTime=this.defaultDeadTime):this.keyboardRotateOuterDeadTime>0?(this.keyboardRotateOuterDeadTime-=e,this.keyboardRotateOuter=.3):this.keyboardRotateOuter=1:this.keyS.isDown||this.keyLeft.isDown||this.keyQ.isDown?this.keyboardRotateOuter>-.25?(this.keyboardRotateOuter=-1.41,this.keyboardRotateOuterDeadTime=this.defaultDeadTime):this.keyboardRotateOuterDeadTime>0?(this.keyboardRotateOuterDeadTime-=e,this.keyboardRotateOuter=-.3):this.keyboardRotateOuter=-1:this.keyboardRotateOuter=0,this.keyboardCasted=!1,!this.keyboardCastRestricted&&(this.keyEnter.isDown||this.keySpace.isDown)?(this.keyboardCasted=!0,this.keyboardCastRestricted=!0):this.keyEnter.isDown||this.keySpace.isDown||(this.keyboardCastRestricted=!1),this.keyboardCasted&&(this.castDisabled||this.recharging?this.bufferedCastAvailable&&!this.recharging&&(this.bufferedCastAvailable=!1,this.useBufferedSpellCast=!0):(this.castSpell(),this.keyboardCasted=!1))),!(s<=this.size)||this.manualDisabled||(gameVars.mouseJustDowned?(this.draggedDuration=0,s<this.castButtonSize?(this.draggedObj=this.castButton,this.setFrameLazy(this.castButton,this.altString+"cast_press.png"),globalObjects.player.setCastTextAlpha(.65)):s<this.innerCircleSize&&!this.innerDragDisabled?(this.draggedObj=this.innerCircle,this.dragPointDist=s,this.dragPointAngle=Math.atan2(i,t),this.dragPointAngleVisual=this.dragPointAngle,this.setFrameLazy(this.innerCircle,this.altString+"element_drag.png")):this.outerDragDisabled||(this.draggedObj=this.outerCircle,this.dragPointDist=Math.min(s,this.trueSize),this.dragPointAngle=Math.atan2(i,t),this.dragPointAngleVisual=this.dragPointAngle,this.setFrameLazy(this.outerCircle,this.altString+"usage_drag.png"))):gameVars.mouseJustUpped?(this.draggedDuration<12&&(this.preventRotDecay=(12-this.draggedDuration)*.4),s<this.castButtonSize&&this.draggedObj===this.castButton&&(this.castDisabled||this.recharging?this.bufferedCastAvailable&&!this.recharging&&(this.bufferedCastAvailable=!1,this.useBufferedSpellCast=!0):(this.castSpell(),this.keyboardCasted=!1))):gameVars.mousedown?(this.draggedDuration+=e,s<this.castButtonSize&&this.draggedObj===this.castButton&&(this.setFrameLazy(this.castButton,this.altString+"cast_press.png"),globalObjects.player.setCastTextAlpha(.6))):(canvas.style.cursor="default",s<this.castButtonSize?(this.setFrameLazy(this.castButton,this.altString+"cast_hover.png"),globalObjects.player.setCastTextAlpha(.7),!this.innerDragDisabled&&!this.outerDragDisabled&&!this.recharging&&!this.castDisabled&&canvas&&(canvas.style.cursor="pointer")):!this.innerDragDisabled&&s<this.innerCircleSize?this.setFrameLazy(this.innerCircle,this.altString+"element_hover.png"):this.outerDragDisabled||this.setFrameLazy(this.outerCircle,this.altString+"usage_hover.png"))),gameVars.mousedown||(this.draggedObj=null),this.innerDragDisabled&&this.innerCircle===this.draggedObj&&(this.draggedObj=null),this.outerDragDisabled&&this.outerCircle===this.draggedObj&&(this.draggedObj=null),e>.9&&e<1.14&&(e=1),e>1.1)for(this.dScaleAccumulate+=e;this.dScaleAccumulate>1;)this.dScaleAccumulate-=1,this.updateInterval(1,t,i);else this.updateInterval(e,t,i);let r=this.voidArm2.alpha>0?.35:.05;this.voidArm.alpha>0&&(this.voidArm.bonusRotation+=(Math.random()-.5)*.05,this.voidArm.bonusRotation*=.98,this.voidArm.rotation=this.voidArm.bonusRotation+r,this.voidArm.alpha>.92&&(this.voidArm.alpha=.92+.08*Math.random())),this.voidArm2.alpha>0&&(this.voidArm2.bonusRotation+=(Math.random()-.5)*.05,this.voidArm2.bonusRotation*=.97,this.voidArm2.rotation=.5*Math.PI+this.voidArm2.bonusRotation+r,this.voidArm2.alpha>.92&&(this.voidArm2.alpha=.92+.08*Math.random())),(0!==this.innerCircle.rotVel||0!==this.outerCircle.rotVel||null!==this.draggedObj)&&(this.lastDragTime=Math.min(this.lastDragTime,0)),this.updateShields(e),this.updateFramesLazy()}updateInterval(e,t,i){if(this.draggedObj&&this.draggedObj!==this.castButton){for(this.dragArrow.visible=!0,this.dragCircle.visible=!0;this.dragPointAngle>2*Math.PI;)this.dragPointAngle-=2*Math.PI;for(;this.dragPointAngle<-2*Math.PI;)this.dragPointAngle+=2*Math.PI;let s=Math.atan2(i,t)-this.dragPointAngle;s>Math.PI?s-=2*Math.PI:s<-Math.PI&&(s+=2*Math.PI),this.prevDragAngleDiff||(this.prevDragAngleDiff=s),this.storedDragAngleDiff=s;let a=(s-this.prevDragAngleDiff)*Math.abs(s);a<-.24?a=-.24:a>.24&&(a=.24);let l=Math.cos(this.dragPointAngle)*this.dragPointDist,r=Math.sin(this.dragPointAngle)*this.dragPointDist,n=t-l,h=i-r,o=Math.sqrt(n*n+h*h),d=n/(o+.001),c=h/(o+.001),$=l/this.dragPointDist,m=r/this.dragPointDist,u=0;u=o<25?Math.max(0,Math.min(1,.015*o)):Math.min(1,.25+.002*o);let g=-m*d+$*c,p=gameVars.wasTouch?.0465:.043;g<0?this.draggedObj.torque=-(u*Math.sqrt(-g))*p*(1+.01*e):this.draggedObj.torque=u*Math.sqrt(g)*p*(1+.01*e),this.draggedObj.torque+=s*p-.38*this.draggedObj.rotVel,this.draggedObj.torqueOnRelease=4*this.draggedObj.torque,this.draggedObj.rotVel*s<-.01&&(this.draggedObj.rotVel*=.2);let b=this.draggedObj.rotation,_=this.draggedObj.nextRotation;this.calculateRotations(e),this.updateRotationVisuals(e);let y=this.draggedObj.rotation-b,D=this.draggedObj.nextRotation-_;this.dragPointAngle+=D,this.dragPointAngleVisual+=y,l=Math.cos(this.dragPointAngleVisual)*this.dragPointDist,r=Math.sin(this.dragPointAngleVisual)*this.dragPointDist,n=t-l,h=i-r,this.dragArrow.setPosition(this.x+l,this.y+r),this.dragCircle.setPosition(this.x+l,this.y+r),this.dragArrow.setScale(Math.max(.08,Math.min(1,.0135*o)),1),this.dragArrow.setAlpha(Math.min(5*this.dragArrow.scaleX-2)),this.dragArrow.setRotation(Math.atan2(h,n)),this.draggedObj==this.innerCircle?this.setFrameLazy(this.innerCircle,this.altString+"element_drag.png"):this.draggedObj==this.outerCircle&&this.setFrameLazy(this.outerCircle,this.altString+"usage_drag.png"),this.prevDragAngleDiff=s}else this.prevDragAngleDiff=null,this.dragArrow.visible=!1,this.dragCircle.visible=!1,this.calculateRotations(e),this.updateRotationVisuals(e)}reset(e,t){this.x=e,this.y=t,this.trueSize=205,this.size=isMobile?252:230,this.draggedObj=null,this.dragPointAngle=0,this.dragPointAngleVisual=this.dragPointAngle,this.dragPointDist=100,this.keyboardRotateOuter=0,this.keyboardRotateInner=0,this.defaultDeadTime=8,this.keyboardRotateOuterDeadTime=5,this.keyboardRotateInnerDeadTime=5,this.keyboardCasted=!1,this.delayedDamage=0,this.delayedDamageBase=60,this.delayedDamageShouldTick=!1}buildCircles(e,t,i){this.aura=i.add.image(e,t,"circle","aura.png"),this.aura.setDepth(101),this.aura.setScale(.9),this.aura.rotVel=0,this.aura.alpha=0,this.voidArm=this.scene.add.sprite(gameConsts.halfWidth,210,"spells","blackHoleArms.png").setScale(1.25),this.voidArm.setDepth(15),this.voidArm.alpha=0,this.voidArm.bonusRotation=0,this.voidArm2=this.scene.add.sprite(gameConsts.halfWidth,210,"spells","blackHoleArms.png").setScale(1.25),this.voidArm2.setDepth(15),this.voidArm2.alpha=0,this.voidArm2.bonusRotation=0,this.delayDamageSandFull=i.add.sprite(e-240,t-130,"circle","delayed_damage_full.png"),this.delayDamagePartial=i.add.graphics().setDepth(101),this.delayDamagePartial.fillStyle(16711680,.7),this.delayDamagePartial.visible=!0,this.delayDamagePartial.setDepth(101),this.delayDamageHourglass=i.add.sprite(e-240,t-130,"circle","delayed_damage.png").setScale(.9),this.delayDamageHourglass.setDepth(101),this.delayDamageHourglass.alpha=0,this.delayDamageSandFull.setDepth(101),this.delayDamageSandFull.alpha=0,this.delayDamageSandFull.origX=this.delayDamageSandFull.x,this.delayDamageText=this.scene.add.bitmapText(this.delayDamageHourglass.x,this.delayDamageHourglass.y,"damage","0",48,0),this.delayDamageText.setDepth(101),this.delayDamageText.alpha=0,this.delayDamageText.setOrigin(.5,-.35),this.altString="",this.outerCircle=i.add.sprite(e,t,"circle",this.altString+"usage_normal.png").setDepth(101),this.outerCircle.torque=0,this.outerCircle.torqueDecay=0,this.outerCircle.torqueOnRelease=0,this.outerCircle.rotVel=0,this.outerCircle.nextRotation=0,this.outerCircle.prevRotation=0,this.innerCircleSize=isMobile?153:149,this.innerCircle=i.add.sprite(e,t,"circle",this.altString+"element_normal.png").setDepth(102),this.innerCircle.setOrigin(.5003,.5003),this.innerCircle.torque=0,this.innerCircle.torqueDecay=0,this.innerCircle.torqueOnRelease=0,this.innerCircle.rotVel=0,this.innerCircle.nextRotation=0,this.innerCircle.prevRotation=0,this.shadowCircle=i.add.sprite(e,t,"circle","shadow.png").setAlpha(0).setDepth(99998).setBlendMode(Phaser.BlendModes.MULTIPLY),this.focusLines=i.add.image(e,t-130,"circle","focus_lines.png").setDepth(121),this.focusLinesOn=i.add.sprite(e,t-130,"circle","focus_lines_on.png").setDepth(121),this.castButtonSize=isMobile?72:78,this.castButton=i.add.sprite(e,t,"circle",this.altString+"cast_normal.png").setDepth(121),this.castButtonSpare=i.add.sprite(e,t,"circle",this.altString+"cast_press.png").setDepth(121).setAlpha(0),this.castHoverTemp=i.add.sprite(e,t,"circle",this.altString+"cast_press.png").setDepth(121).setAlpha(0),this.castGlow=i.add.sprite(e,t,"circle","cast_glow.png").setDepth(121).setAlpha(0),this.greyedDead=i.add.sprite(e,t,"circle","greyed_dead.png").setVisible(!1).setDepth(135),this.greyed=i.add.sprite(e,t,"circle","greyed.png").setVisible(!1).setDepth(122).setVisible(!1).setScale(1.01),this.errorBoxElement=i.add.sprite(e,t-115,"circle","error_box.png"),this.errorBoxElement.setDepth(131),this.errorBoxElement.alpha=0,this.errorBoxEmbodiment=i.add.sprite(e,t-175,"circle","error_box.png"),this.errorBoxEmbodiment.setDepth(131),this.errorBoxEmbodiment.alpha=0,this.showRunes=!1,this.spellElementText=this.scene.add.bitmapText(this.x-11,this.y-283,"normal","MATTER",isMobile?30:28,1),this.spellElementText.setScale(.7),this.spellElementText.setOrigin(1,.5),this.spellElementText.setDepth(125),this.spellElementText.alpha=.55,this.spellElementText.startY=this.spellElementText.y,this.spellElementText.visible=this.showRunes,this.spellNameText=this.scene.add.bitmapText(this.x+1,this.y-283,"normal","+",isMobile?30:28,1),this.spellNameText.setScale(.7),this.spellNameText.setOrigin(.5,.5),this.spellNameText.setDepth(125),this.spellNameText.startY=this.spellNameText.y,this.spellNameText.alpha=.55,this.spellActionText=this.scene.add.bitmapText(this.x+13,this.y-283,"normal","STRIKE",isMobile?30:28,1),this.spellActionText.setScale(.7),this.spellActionText.setOrigin(0,.5),this.spellActionText.setDepth(125),this.spellActionText.alpha=.55,this.spellActionText.startY=this.spellActionText.y,this.spellActionText.visible=this.showRunes,this.voidSliceImage1=i.add.sprite(gameConsts.halfWidth-100,255,"spells","darkSlice.png").setDepth(21).setRotation(-(.5*Math.PI)+.6).setAlpha(0).setOrigin(.17,.5),this.voidSliceImage3=i.add.sprite(gameConsts.halfWidth+100,255,"spells","darkSlice.png").setDepth(21).setRotation(-(.5*Math.PI)-.6).setAlpha(0).setOrigin(.17,.5),this.mindBurnAnim=this.scene.add.sprite(gameConsts.halfWidth,150,"spells").play("mindBurn").setDepth(1).setAlpha(0).setDepth(10).setBlendMode(Phaser.BlendModes.ADD),this.spellDescriptor=new HoverDisplay({x:gameConsts.halfWidth,y:0,originX:.485,originY:1,depth:200}),this.refreshHoverText(),this.dragCircle=i.add.sprite(e,t,"circle","drag_circle.png").setAlpha(isMobile?.75:.55),this.dragCircle.setDepth(100001),this.dragCircle.visible=!1,this.dragArrow=i.add.sprite(e,t,"circle","drag_arrow.png"),this.dragArrow.setDepth(100001),this.dragArrow.setOrigin(.2,.5),this.dragArrow.visible=!1,this.elementHighlight=this.scene.add.sprite(e,t,"circle","bright_rune_matter.png").setOrigin(.5,.866).setDepth(104),this.embodimentHighlight=this.scene.add.sprite(e,t,"circle","bright_rune_strike.png").setOrigin(.5,1.22).setDepth(104),this.buildRunes()}createTimeStopObjs(){this.gearBonusSpeed=5,this.timeStopHeavy=this.scene.add.sprite(this.x,this.y,"spells","blackCircleLarge.png").setDepth(-3),this.timeStopHeavy.alpha=0,this.timeStopHeavy.setScale(1.7),this.clockbg=this.scene.add.sprite(gameConsts.halfWidth,gameConsts.halfHeight-5,"lowq","clockbg.png").setAlpha(0).setScale(1.4),this.clockbg.setDepth(-3),this.gear1=this.scene.add.sprite(-40,280,"circle","gear.png").setAlpha(0),this.gear1.setDepth(1),this.gear1.startX=this.gear1.x,this.gear1.startY=this.gear1.y,this.gear2=this.scene.add.sprite(120,442,"circle","gear_small.png").setAlpha(0),this.gear2.setDepth(1),this.gear2.rotation=-.25,this.gear2.startX=this.gear2.x,this.gear2.startY=this.gear2.y,this.gear3=this.scene.add.sprite(565,-15,"circle","gear.png").setAlpha(0),this.gear3.setDepth(1),this.gear3.startX=this.gear3.x,this.gear3.startY=this.gear3.y,this.gear4=this.scene.add.sprite(538,575,"circle","gear_small.png").setAlpha(0),this.gear4.setDepth(1),this.gear4.startX=this.gear4.x,this.gear4.startY=this.gear4.y}finishUpMindDamage(e){this.laserIsFiring=!1}handleTimeSlow(e){1===gameVars.timeSlowRatio?(this.gearBonusSpeed=Math.min(10,this.gearBonusSpeed+e),this.gearBonusSpeed<10&&(this.gear1.rotation+=.0045*e*this.gearBonusSpeed,this.gear2.rotation-=.006*e*this.gearBonusSpeed,this.gear3.rotation+=.003*e*this.gearBonusSpeed,this.gear4.rotation+=.006*e*this.gearBonusSpeed)):(this.gearBonusSpeed=Math.max(.1,Math.max(gameVars.timeSlowRatio,.985*this.gearBonusSpeed-.03*e)),this.gear1.rotation+=.0045*e*this.gearBonusSpeed,this.gear2.rotation-=.006*e*this.gearBonusSpeed,this.gear3.rotation+=.003*e*this.gearBonusSpeed,this.gear4.rotation+=.006*e*this.gearBonusSpeed)}timeSlowFromEnemy(){gameVars.timeSlowRatio=.9,this.timeStopHeavy.setScale(1.95),this.timeStopHeavy.setAlpha(1),this.timeStopHeavy.y=150,this.scene.tweens.add({targets:this.timeStopHeavy,scaleX:7,scaleY:7,alpha:.8,ease:"Cubic.easeIn",duration:280*gameVars.gameManualSlowSpeed}),this.scene.tweens.add({targets:this.clockbg,alpha:.1,scaleX:1.3,scaleY:1.3,duration:250*gameVars.gameManualSlowSpeed}),this.gear1.setPosition(gameConsts.halfWidth,190).setScale(1.13),this.gear2.setPosition(gameConsts.halfWidth,190).setScale(.88),this.gear3.setPosition(gameConsts.halfWidth,190).setScale(2.09),this.scene.tweens.add({targets:[this.gear1,this.gear2,this.gear3],ease:"Quart.easeOut",alpha:.15,duration:1e3*gameVars.gameManualSlowSpeed}),this.scene.tweens.add({targets:[this.gear4],ease:"Quart.easeOut",alpha:0,duration:1e3*gameVars.gameManualSlowSpeed})}cancelTimeSlow(){messageBus.publish("clearGameSlow"),1!==gameVars.timeSlowRatio&&(gameVars.timeSlowRatio=1,globalObjects.currentEnemy&&globalObjects.currentEnemy.bgMusic&&(globalObjects.currentEnemy.bgMusic.detune=0),this.scene.tweens.add({targets:[this.timeStopHeavy],ease:"Quint.easeOut",alpha:.01,duration:700*gameVars.gameManualSlowSpeed,onComplete:()=>{this.scene.tweens.add({targets:[this.timeStopHeavy],alpha:0,duration:500*gameVars.gameManualSlowSpeed})}}),this.scene.tweens.add({targets:[this.gear1,this.gear2,this.gear3,this.gear4,this.clockbg],ease:"Quad.easeIn",alpha:0,duration:300*gameVars.gameManualSlowSpeed}))}manualSetTimeSlowRatio(e=1,t=1){this.setTimeSlowRatio(e/t,!0),e>.999?messageBus.publish("clearGameSlow"):(gameVars.gameManualSlowSpeed=.46,gameVars.gameManualSlowSpeedInverse=1/gameVars.gameManualSlowSpeed,PhaserScene.tweens.timeScale=.46,PhaserScene.anims.globalTimeScale=.46),this.timeStopHeavy.y=this.y,this.timeStopHeavy.setScale(1.7),this.timeStopHeavy.setAlpha(1);let i=Math.max(0,(t-2)/t);this.scene.tweens.add({targets:this.timeStopHeavy,scaleX:7,scaleY:7,alpha:.8+.2*i,ease:"Cubic.easeIn",duration:280*gameVars.gameManualSlowSpeed}),this.scene.tweens.add({targets:this.clockbg,alpha:.07+.025*i,scaleX:1.3,scaleY:1.3,duration:250*gameVars.gameManualSlowSpeed}),this.gear1.setPosition(this.gear1.startX,this.gear1.startY).setScale(1).setDepth(1),this.gear2.setPosition(this.gear2.startX,this.gear2.startY).setScale(1).setDepth(1),this.gear3.setPosition(this.gear3.startX,this.gear3.startY).setScale(1).setDepth(1),this.gear4.setPosition(this.gear4.startX,this.gear4.startY),this.scene.tweens.add({targets:[this.gear1,this.gear2,this.gear3,this.gear4],ease:"Quart.easeOut",alpha:.2+.11*i,duration:1e3*gameVars.gameManualSlowSpeed})}setTimeSlowRatio(e=1,t=!1){let i=gameVars.timeSlowRatio;gameVars.timeSlowRatio=e,e<.99?(playSound("timeSlow"),globalObjects.currentEnemy&&globalObjects.currentEnemy.bgMusic&&(globalObjects.currentEnemy.bgMusic.detune=-1e3)):globalObjects.currentEnemy&&globalObjects.currentEnemy.bgMusic&&(globalObjects.currentEnemy.bgMusic.detune=0),i!=e&&(messageBus.publish("setTimeSlowRatio",e),1==e&&(this.scene.tweens.add({targets:[this.timeStopHeavy],ease:"Quint.easeOut",alpha:.01,duration:700*gameVars.gameManualSlowSpeed,onComplete:()=>{this.scene.tweens.add({targets:[this.timeStopHeavy],alpha:0,duration:500*gameVars.gameManualSlowSpeed})}}),this.scene.tweens.add({targets:[this.gear1,this.gear2,this.gear3,this.gear4,this.clockbg],ease:"Quad.easeIn",alpha:0,duration:300*gameVars.gameManualSlowSpeed})))}attackLaunched(){let e=globalObjects.player.getStatuses().mindReinforce;if(e){let t=e.multiplier,i=e.animObj[1],s=e.animObj[1];this.scene.tweens.add({targets:i,duration:150*gameVars.gameManualSlowSpeed,scaleX:1.135+.02*t,scaleY:1.135+.02*t,alpha:1,ease:"Cubic.easeOut",onComplete:()=>{this.scene.tweens.add({targets:i,duration:400*gameVars.gameManualSlowSpeed,scaleX:.975+.01*t,scaleY:.975+.01*t,ease:"Back.easeOut",onComplete:()=>{this.scene.tweens.add({targets:i,duration:750*gameVars.gameManualSlowSpeed,alpha:.6})}})}}),this.scene.tweens.add({targets:s,duration:200*gameVars.gameManualSlowSpeed,scaleX:1.17+.02*t,scaleY:1.17+.02*t,alpha:1,ease:"Cubic.easeOut",onComplete:()=>{this.scene.tweens.add({targets:s,duration:550*gameVars.gameManualSlowSpeed,scaleX:1+.012*t,scaleY:1+.012*t,ease:"Back.easeOut",onComplete:()=>{this.scene.tweens.add({targets:s,duration:750*gameVars.gameManualSlowSpeed,alpha:.6})}})}}),this.showReadySprite(!0,1.5)}}buildRunes(){let e=this.x,t=this.y;if(this.elements)for(let i=0;i<this.elements.length;i++)this.elements[i].destroy(),this.elements[i].glow.destroy();if(this.embodiments)for(let s=0;s<this.embodiments.length;s++)this.embodiments[s].destroy(),this.embodiments[s].glow.destroy();this.elements=[],this.embodiments=[];for(let a=0;a<ELEMENT_ARRAY.length;a++)this.elements[a]=this.scene.add.sprite(e,t,"circle",ELEMENT_ARRAY[a]+".png"),this.elements[a].setOrigin(.5,.866),this.elements[a].setDepth(103),this.elements[a].rotation=2*Math.PI/ELEMENT_ARRAY.length*a,this.elements[a].startRotation=this.elements[a].rotation,this.elements[a].runeName=ELEMENT_ARRAY[a],this.elements[a].alpha=.44,this.elements[a].glow=this.scene.add.sprite(e,t,"circle",ELEMENT_ARRAY[a]+"_glow.png"),this.elements[a].glow.setOrigin(.5,.866),this.elements[a].glow.setDepth(103).setAlpha(.99),this.elements[a].glow.rotation=this.elements[a].rotation;for(let l=0;l<EMBODIMENT_ARRAY.length;l++)this.embodiments[l]=this.scene.add.sprite(e,t,"circle",EMBODIMENT_ARRAY[l]+".png"),this.embodiments[l].setOrigin(.5,1.22),this.embodiments[l].setDepth(103),this.embodiments[l].rotation=2*Math.PI/EMBODIMENT_ARRAY.length*l,this.embodiments[l].startRotation=this.embodiments[l].rotation,this.embodiments[l].runeName=EMBODIMENT_ARRAY[l],this.embodiments[l].alpha=.44,this.embodiments[l].glow=this.scene.add.sprite(e,t,"circle",EMBODIMENT_ARRAY[l]+"_glow.png"),this.embodiments[l].glow.setOrigin(.5,1.22),this.embodiments[l].glow.setDepth(103).setAlpha(.99),this.embodiments[l].glow.rotation=this.embodiments[l].rotation}setFrameLazy(e,t){e.lazyFrame=t}updateRotationVisuals(e){this.aura.rotVel+=.006*this.innerCircle.rotVel*e+.008*this.outerCircle.rotVel*e,this.aura.rotVel*=1-.07*e,this.aura.rotation+=.001*e+this.aura.rotVel,this.aura.setScale(.9+Math.abs(this.aura.rotVel));for(let t=0;t<this.elements.length;t++)this.elements[t].rotation=this.innerCircle.rotation+this.elements[t].startRotation,this.elements[t].glow.rotation=this.elements[t].rotation;for(let i=0;i<this.embodiments.length;i++)this.embodiments[i].rotation=this.outerCircle.rotation+this.embodiments[i].startRotation,this.embodiments[i].glow.rotation=this.embodiments[i].rotation;this.elementHighlight.closest&&(this.elementHighlight.rotation=this.elementHighlight.closest.rotation),this.embodimentHighlight.closest&&(this.embodimentHighlight.rotation=this.embodimentHighlight.closest.rotation)}calculateRotations(e,t=99){if(this.innerDragDisabled||this.outerDragDisabled)return;let i=999,s=999,a=999,l=999,r=null,n=null;for(let h=0;h<this.elements.length;h++)Math.abs(a=this.getRotationDiff(this.innerCircle.nextRotation,-this.elements[h].startRotation))<Math.abs(i)&&(i=a,r=this.elements[h]);for(let o=0;o<this.embodiments.length;o++)Math.abs(l=this.getRotationDiff(this.outerCircle.nextRotation,-this.embodiments[o].startRotation))<Math.abs(s)&&(s=l,n=this.embodiments[o]);this.outerDragDisabled||this.castDisabled||this.manualDisabled||this.recharging?(this.elementHighlight.visible=!1,this.embodimentHighlight.visible=!1):(r.glow.visible?(this.elementHighlight.closest=r,this.elementHighlight.visible=!0,this.elementHighlight.setRotation(r.rotation).setFrame("bright_"+r.frame.name).setOrigin(.5,.866)):this.elementHighlight.visible=!1,n.glow.visible?(this.embodimentHighlight.closest=n,this.embodimentHighlight.visible=!0,this.embodimentHighlight.setRotation(n.rotation).setFrame("bright_"+n.frame.name).setOrigin(.5,1.22)):this.embodimentHighlight.visible=!1),this.recentlyUpdatedSpellHover?this.recentlyUpdatedSpellHover=!1:(this.recentlyUpdatedSpellHover=!0,this.updateSpellHover(r,n,i,s));let d=this.innerCircle.torque*this.innerCircle.torque>1e-5?.6:1,c=this.outerCircle.torque*this.outerCircle.torque>1e-5?.6:1,$=(Math.abs(this.innerCircle.rotVel)+.001)/.004,m=(Math.abs(this.outerCircle.rotVel)+.001)/.004,u=1-45e-6*e*1*d*$,g=1-45e-6*e*.9*c*m,p=.0054*e*1*d,b=.0054*e*.84*c;if(0===this.keyboardRotateInner||this.innerDragDisabled)this.usedKeyboardInner&&(this.usedKeyboardInner=!1,this.innerCircle.rotVel*=.7);else{this.usedKeyboardInner=!0;let _=.005/(.005+Math.abs(this.innerCircle.rotVel));this.innerCircle.torque=.05*this.keyboardRotateInner*_}if(0===this.keyboardRotateOuter||this.outerDragDisabled)this.usedKeyboardOuter&&(this.usedKeyboardOuter=!1,this.outerCircle.rotVel*=.7);else{this.usedKeyboardOuter=!0;let y=.005/(.005+Math.abs(this.outerCircle.rotVel));this.outerCircle.torque=.05*this.keyboardRotateOuter*y}if(Math.abs(this.innerCircle.rotVel)>.01&&(this.innerCircle.torque*=.7),Math.abs(this.outerCircle.rotVel)>.01&&(this.outerCircle.torque*=.7),this.forcingAlignment&&(this.innerCircle.torque=0,this.outerCircle.torque=0),this.innerCircle.rotVel+=this.innerCircle.torque,this.outerCircle.rotVel+=this.outerCircle.torque,this.preventRotDecay>0?this.preventRotDecay-=e:(this.innerCircle.rotVel<-.0001?(this.innerCircle!==this.draggedObj&&0===this.keyboardRotateInner&&i>0&&this.innerCircle.rotVel>-.1&&this.innerCircle.rotVel<-.028&&(p*=3.1,u*=.98),this.innerCircle.rotVel=Math.min(0,this.innerCircle.rotVel*u+p)):this.innerCircle.rotVel>1e-4?(this.innerCircle!==this.draggedObj&&0===this.keyboardRotateInner&&i<0&&this.innerCircle.rotVel<.1&&this.innerCircle.rotVel>.028&&(p*=3.1,u*=.98),this.innerCircle.rotVel=Math.max(0,this.innerCircle.rotVel*u-p)):this.innerCircle.rotVel=0,this.outerCircle.rotVel<-.0001?(this.outerCircle!==this.draggedObj&&0===this.keyboardRotateOuter&&s>0&&this.outerCircle.rotVel<-.024&&this.outerCircle.rotVel>-.09&&(b*=3.5,g*=.98),this.outerCircle.rotVel=Math.min(0,this.outerCircle.rotVel*g+b)):this.outerCircle.rotVel>1e-4?(this.outerCircle!==this.draggedObj&&0===this.keyboardRotateOuter&&s<0&&this.outerCircle.rotVel<.09&&this.outerCircle.rotVel>.024&&(b*=3.5,g*=.98),this.outerCircle.rotVel=Math.max(0,this.outerCircle.rotVel*g-b)):this.outerCircle.rotVel=0),Math.abs(this.innerCircle.rotVel)>.036&&(this.innerCircle.rotVel*=.98),Math.abs(this.outerCircle.rotVel)>.036&&(this.outerCircle.rotVel*=.98),0===this.innerCircle.torque&&Math.abs(this.innerCircle.torqueOnRelease)>.001){if(this.innerCircle.torqueOnRelease*this.innerCircle.rotVel<0)this.innerCircle.rotVel*=.05;else if(Math.abs(this.innerCircle.torqueOnRelease)>.005){let D=Math.min(1.6,Math.max(1,1*Math.abs(this.innerCircle.torqueOnRelease)/.005));this.innerCircle.rotVel*=D,this.innerCircle.rotVel>-.043&&this.innerCircle.rotVel<-.009?this.innerCircle.rotVel=-.043:this.innerCircle.rotVel<.043&&this.innerCircle.rotVel>.009&&(this.innerCircle.rotVel=.043),this.innerCircle.nextRotation+=this.innerCircle.rotVel}else this.innerCircle.rotVel=0;this.innerCircle.torqueOnRelease=0}if(0===this.outerCircle.torque&&Math.abs(this.outerCircle.torqueOnRelease)>.001){if(this.outerCircle.torqueOnRelease*this.outerCircle.rotVel<0)this.outerCircle.rotVel*=.05;else if(Math.abs(this.outerCircle.torqueOnRelease)>.005){let S=Math.min(1.6,Math.max(1,1*Math.abs(this.outerCircle.torqueOnRelease)/.005));this.outerCircle.rotVel*=S,this.outerCircle.rotVel>-.038&&this.outerCircle.rotVel<-.006?this.outerCircle.rotVel=-.038:this.outerCircle.rotVel<.038&&this.outerCircle.rotVel>.006&&(this.outerCircle.rotVel=.038),this.outerCircle.nextRotation+=this.outerCircle.rotVel}else this.outerCircle.rotVel=0;this.outerCircle.torqueOnRelease=0}let C=.01>Math.abs(this.innerCircle.rotVel)?2:1,w=.01>Math.abs(this.outerCircle.rotVel)?2.25:1,f=0,x=0,A=e+.1,T=A*A,O=gameVars.wasTouch?.15:.08;this.storedDragAngleDiff>O?this.storedDragAngleDiff=O:this.storedDragAngleDiff<-O&&(this.storedDragAngleDiff=-O),this.draggedObj===this.innerCircle?f=this.storedDragAngleDiff*(gameVars.wasTouch?.06:.05)*T:this.draggedObj===this.outerCircle&&(x=this.storedDragAngleDiff*(gameVars.wasTouch?.06:.05)*T),this.storedDragAngleDiff=0;let k=this.innerCircle.rotVel+this.innerCircle.torque*e*5*C+f,v=this.outerCircle.rotVel+this.outerCircle.torque*e*3.5*w+x,R=1-(1-gameVars.timeSlowRatio)*.02,M=this.handleSpinSnapSlowAmt(this.innerCircle,this.elements),j=this.handleSpinSnapSlowAmt(this.outerCircle,this.embodiments),E=1,I=globalObjects.player.spellMultiplier();I>1&&(E=.85,I>3&&(E=.6)),this.innerCircle.prevRotation=this.innerCircle.nextRotation,this.outerCircle.prevRotation=this.outerCircle.nextRotation,this.innerCircle.nextRotation+=k*R*M*E,this.outerCircle.nextRotation+=v*R*j*E,this.innerCircle.rotation=(this.innerCircle.nextRotation+this.innerCircle.prevRotation)*.5,this.outerCircle.rotation=(this.outerCircle.nextRotation+this.outerCircle.prevRotation)*.5,this.autolockRune(1),this.innerCircle.torqueDecay=this.innerCircle.torqueDecay/(1+e)+this.innerCircle.torque,this.outerCircle.torqueDecay=this.outerCircle.torqueDecay/(1+e)+this.outerCircle.torque,this.innerCircle.torque=0,this.outerCircle.torque=0}handleSpinSnapSlowAmt(e,t){let i=999,s=null,a=999;for(let l=0;l<t.length;l++)Math.abs(a=this.getRotationDiff(e.rotation,t[l].startRotation))<Math.abs(i)&&(i=a,s=t[l]);let r=1;return i<.025&&i>.001?r=Math.min(.9,.5+10*Math.abs(e.rotVel)):i>.15&&(r=1.5),r}autolockRune(e){if(this.draggedObj!==this.innerCircle){let t=999;for(let i=0;i<this.elements.length;i++){let s=this.getRotationDiff(this.innerCircle.nextRotation+2*this.innerCircle.rotVel,this.elements[i].startRotation);Math.abs(s)<Math.abs(t)&&(t=s)}let a=Math.abs(t);if(t<.45&&a>.005){let l=Math.min(1,Math.max(0,1-1.8*a));l*=l*l*l,this.innerCircle.rotation-=t*l;let r=Math.max(0,1-Math.max(0,25*Math.abs(this.innerCircle.rotVel)));this.innerCircle.nextRotation-=.24*t*r}}if(this.draggedObj!==this.outerCircle){let n=999;for(let h=0;h<this.embodiments.length;h++){let o=this.getRotationDiff(this.outerCircle.nextRotation+2*this.outerCircle.rotVel,this.embodiments[h].startRotation);Math.abs(o)<Math.abs(n)&&(n=o)}let d=Math.abs(n);if(.4>Math.abs(n)&&d>.005){let c=Math.min(1,Math.max(0,1-2*d));c*=c*c*c,this.outerCircle.rotation-=n*c;let $=Math.max(0,1-Math.max(0,25*Math.abs(this.outerCircle.rotVel)));this.outerCircle.nextRotation-=.2*n*$}}}updateFramesLazy(){let e="circle";this.castDisabled?this.castButton.frame.name!==this.altString+"cast_disabled.png"&&(this.castGlow.alpha=.5,this.scene.tweens.add({targets:this.castGlow,duration:1e3*gameVars.gameManualSlowSpeed,ease:"Quint.easeOut",alpha:0}),this.castButton.setTexture(e,this.altString+"cast_disabled.png")):this.castButton.frame.customData.filename!==this.castButton.lazyFrame&&(this.castButton.frame.customData.filename===this.altString+"cast_disabled.png"&&this.castButton.lazyFrame===this.altString+"cast_normal.png"&&(this.castButtonSpare.alpha=.6,this.scene.tweens.add({targets:this.castButtonSpare,duration:400*gameVars.gameManualSlowSpeed,ease:"Cubic.easeOut",alpha:0})),this.castButton.setTexture(e,this.castButton.lazyFrame)),this.innerCircle.frame.customData.filename!==this.innerCircle.lazyFrame&&this.innerCircle.setTexture(e,this.innerCircle.lazyFrame).setOrigin(.50012,.5),this.outerCircle.lazyFrame&&this.outerCircle.frame.customData.filename!==this.outerCircle.lazyFrame&&this.outerCircle.setTexture(e,this.outerCircle.lazyFrame).setOrigin(.4999,.5000001)}updateShields(e){let t=globalObjects.player.getStatuses(),i=[];for(let s=0;s<this.tempRotObjs.length;s++)this.tempRotObjs[s].rotation=this.tempLockRot+this.outerCircle.rotation;let a=t.matterUnload;a&&(a.animObj[0].rotation=this.outerCircle.rotation);let l=t.matterReinforce;if(l){let r=l.animObj[0],n=l.animObj[1];r.rotation=this.outerCircle.rotation,n.rotation=this.outerCircle.rotation}for(let h=0;h<10;h++)t["shield"+h]&&i.push(t["shield"+h]);for(let o=0;o<i.length;o++){let d=i[o];d.animObj[0]===this.tempRotObjs[0]&&(this.tempRotObjs=[]);let c=0;switch(d.type){case"mind":let $=.28+.03*d.multiplier,m=d.lockRotation+this.outerCircle.rotation;if(d.isLocked||(d.animObj[0].rotation=m),d.isBlasting){d.animObj[2].visible=!0;let u=m+d.animObj[2].rotateOffset;d.animObj[2].rotation=u;let g=Math.sin(u),p=Math.cos(u);d.animObj[2].x=d.animObj[2].startX+210*g,d.animObj[2].y=d.animObj[2].startY-210*p+220,d.textObj.x=d.animObj[2].startX+150*g,d.textObj.y=d.animObj[2].startY-150*p+175}else if(d.impactVisibleTime>0){d.animObj[2].visible=!0,d.impactVisibleTime=Math.max(0,d.impactVisibleTime-e);let b=m+d.animObj[2].rotateOffset;d.animObj[2].rotation=b;let _=Math.sin(b),y=Math.cos(b);d.animObj[2].x=d.animObj[2].startX+220*_,d.animObj[2].y=d.animObj[2].startY-220*y+220,d.textObj.x=d.animObj[2].startX+150*_,d.textObj.y=d.animObj[2].startY-150*y+175}else d.animObj[2].visible&&(d.animObj[2].visible=!1);(c=Math.abs(d.animObj[0].rotation))<$?d.active||(d.active=!0,this.scene.tweens.add({targets:d.animObj[0],duration:275*gameVars.gameManualSlowSpeed,scaleX:1.05*d.animObj[0].origScaleX,easeParams:[4],scaleY:1,ease:"Back.easeOut"})):c>1.1*$&&d.active&&(d.active=!1,d.animObj[0].currAnim&&d.animObj[0].currAnim.stop(),this.scene.tweens.add({targets:d.animObj[0],duration:275*gameVars.gameManualSlowSpeed,scaleX:d.animObj[0].origScaleX-.2,scaleY:.985,ease:"Cubic.easeOut"})),d.animObj[0].alpha=d.active?.82:.5,d.animObj[1].visible=d.active;break;case"matter":let D=.54+.03*d.multiplier,S=d.lockRotation+this.outerCircle.rotation;if(d.animObj[0].rotation=S,d.animObj[1].x=d.animObj[1].startX+222*Math.sin(S),d.animObj[1].y=d.animObj[1].startY-222*Math.cos(S)+222,d.impactVisibleTime>0){d.animObj[2].visible=!0,d.impactVisibleTime=Math.max(0,d.impactVisibleTime-e);let C=S+d.animObj[2].rotateOffset;d.animObj[2].rotation=C,d.animObj[2].x=d.animObj[2].startX+225*Math.sin(C),d.animObj[2].y=d.animObj[2].startY-225*Math.cos(C)+225}else d.animObj[2].visible&&(d.animObj[2].visible=!1);if(c=Math.abs(d.animObj[0].rotation),d.shakeAmt>0){let w=d.shakeAmt*(Math.random()-.5);d.shakeAmt=Math.max(0,d.shakeAmt-.012*e),d.animObj[0].rotation+=w}c<D?d.active||(d.active=!0,d.animObj[0].alpha=1,d.animObj[1].alpha=1,this.scene.tweens.add({targets:d.animObj[0],duration:275*gameVars.gameManualSlowSpeed,scaleX:d.animObj[0].origScaleX,easeParams:[3],scaleY:1,ease:"Back.easeOut"})):c>1.1*D&&d.active&&(d.active=!1,d.animObj[0].alpha=.75,d.animObj[1].alpha=.75,d.animObj[0].currAnim&&d.animObj[0].currAnim.stop(),this.scene.tweens.add({targets:d.animObj[0],duration:275*gameVars.gameManualSlowSpeed,scaleX:d.animObj[0].origScaleX-.06,scaleY:.99,ease:"Cubic.easeOut"}));break;case"time":let f=.52+.03*d.multiplier,x=d.lockRotation+this.outerCircle.rotation,A=x,T=d.animObj[1].rotation;x>T+2*Math.PI-.5?T+=2*Math.PI:x<T-2*Math.PI+.5&&(T-=2*Math.PI);let O=.5*x+.5*T;if(d.animObj[0].rotation=A,d.animObj[1].rotation=O,c=Math.abs(d.animObj[0].rotation),d.shakeAmt>0){let k=d.shakeAmt*(Math.random()-.5);d.shakeAmt=Math.max(0,d.shakeAmt-.012*e),d.animObj[0].rotation+=k,d.animObj[1].rotation+=.5*k}c<f?d.active||(d.active=!0,d.animObj[0].alpha=.85,d.animObj[1].alpha=.85,this.scene.tweens.add({targets:[d.animObj[0],d.animObj[1]],duration:250*gameVars.gameManualSlowSpeed,scaleX:d.animObj[0].origScaleX,scaleY:.965,ease:"Cubic.easeOut"})):c>1.1*f&&d.active&&(d.active=!1,d.animObj[0].alpha=.5,d.animObj[1].alpha=.5,this.scene.tweens.add({targets:[d.animObj[0],d.animObj[1]],duration:250*gameVars.gameManualSlowSpeed,scaleX:d.animObj[0].origScaleX-.35,scaleY:.95,ease:"Cubic.easeOut"}));break;case"void":let v=d.lockRotation+this.outerCircle.rotation,R=d.animObj[0],M=d.animObj[1];d.animObj[2].rotation=v,d.jiggleAmt=Math.max(0,d.jiggleAmt-.01*e);let j=(R.length-1)/2;for(let E=0;E<R.length;E++){let I=j-E;I*=I;let B=d.spreadAmt*R[E].rotationOffset;R[E].x=R[E].startX+Math.sin(v+B)*(206+-.8*I),R[E].y=R[E].startY-Math.cos(v+B)*(210+-.8*I)-10,R[E].scaleVel+=((Math.random()-.45)*(.003+.08*d.jiggleAmt)+(.95-.01*I-R[E].scaleX)*(.005+.008*d.jiggleAmt))*e,R[E].scaleVel*=1-(.03+.02*d.jiggleAmt)*e,R[E].setScale(R[E].scaleX+R[E].scaleVel)}for(let V=0;V<M.length;V++)M[V].x=M[V].startX+206*Math.sin(v+M[V].rotationOffset),M[V].y=M[V].startY-209*Math.cos(v+M[V].rotationOffset)-11,M[V].rotVel+=(Math.random()-.5)*.02*e,M[V].rotVel*=1-.02*e,M[V].rotation+=M[V].rotVel;if(Math.random()<(.003+.001*M.length)*e){let P=Math.floor(Math.random()*M.length);this.scene.tweens.add({targets:M[P],duration:150*gameVars.gameManualSlowSpeed,scaleX:.1,ease:"Cubic.easeIn",onComplete:()=>{this.scene.tweens.add({targets:M[P],duration:150*gameVars.gameManualSlowSpeed,scaleX:1,ease:"Cubic.easeOut"})}})}if((c=Math.abs(v))<.48){d.active=!0,d.spreadAmt+=(1-d.spreadAmt)*.1*e;for(let X=0;X<R.length;X++)R[X].scaleVel+=.001*e}else c>.528&&(d.active=!1,d.spreadAmt+=(.8-d.spreadAmt)*.1*e)}}}getRotationDiff(e,t){let i=e-t;for(;i>3.142;)i-=2*Math.PI;for(;i<-3.142;)i+=2*Math.PI;return i}castSpell(e=!1){if(this.manualDisabled)return;this.castDisabled=!0,this.useBufferedSpellCast=!1,this.bufferedCastAvailable=!1;let t=999,i=999,s=null,a=null,l=0;e&&(this.castHoverTempAnim&&this.castHoverTempAnim.stop(),this.castHoverTemp.alpha=1,this.castHoverTempAnim=this.scene.tweens.add({targets:this.castHoverTemp,duration:500*gameVars.gameManualSlowSpeed,ease:"Cubic.easeOut",alpha:0}));for(let r=0;r<this.elements.length;r++){let n=this.getRotationDiff(this.innerCircle.rotation,this.elements[r].startRotation);if(Math.abs(n)<Math.abs(t)){t=n;let h=this.elements.length-r;0===r&&(h=0),s=this.elements[h]}}(Math.abs(t)>.24||s.burnedOut)&&(s=null);for(let o=0;o<this.embodiments.length;o++){let d=this.getRotationDiff(this.outerCircle.rotation,this.embodiments[o].startRotation);if(Math.abs(d)<Math.abs(i)){i=d;let c=this.embodiments.length-o;0===o&&(c=0),a=this.embodiments[c],l=c}}if((Math.abs(i)>.22||a.burnedOut)&&(a=null,l=-1),s&&null==s.runeName&&(s=null),a&&null==a.runeName&&(a=null),null!==s&&null!==a)cheats.infiniteAmmo||(s.glow.visible=!1,a.glow.visible=!1,s.burnedOut=!0,a.burnedOut=!0),this.forcingAlignment=!0,this.outerCircle.rotVel*=.01,this.innerCircle.rotVel*=.01,this.createElementCast(s),this.createEmbodimentCast(a,()=>{this.trueCastSpell(s,a,l,a.startRotation)}),this.spellNameTextAnim&&this.spellNameTextAnim.stop(),this.spellDescriptor.addTween({ease:"Cubic.easeIn",alpha:0,duration:400*gameVars.gameManualSlowSpeed}),this.spellNameTextAnim=this.scene.tweens.add({targets:[this.spellNameText,this.spellElementText,this.spellActionText],ease:"Cubic.easeIn",alpha:0,duration:400*gameVars.gameManualSlowSpeed}),messageBus.publish("spellClicked");else{let $=this.keyboardCasted?150:0;PhaserScene.time.delayedCall(gameVars.gameManualSlowSpeed*$,()=>{this.bufferedCastAvailable=!0,PhaserScene.time.delayedCall(250*gameVars.gameManualSlowSpeed,()=>{this.castDisabled=!1,this.bufferedCastAvailable=!1,this.useBufferedSpellCast&&this.castSpell(!0)})}),null==s&&this.flashElement(this.errorBoxElement),null==a&&this.flashElement(this.errorBoxEmbodiment)}let m=!1,u=!1;for(let g=0;g<this.elements.length;g++)if(!this.elements[g].burnedOut&&null!=this.elements[g].runeName){m=!0;break}for(let p=0;p<this.embodiments.length;p++)if(!this.embodiments[p].burnedOut&&null!=this.embodiments[p].runeName){u=!0;break}m&&u||(this.elementHighlight.visible=!1,this.embodimentHighlight.visible=!1,this.innerDragDisabled=!0,this.outerDragDisabled=!0,this.castDisabled=!0,this.disableSpellDescDisplay=!0,this.recharging=!0,this.lastDragTime=-1e3,messageBus.publish("resetCircle"),this.scene.tweens.add({targets:this.innerCircle,ease:"Back.easeIn",easeParams:[1.1],onComplete:()=>{this.resetElements(),this.innerDragDisabled=!1,this.innerDragDisabled||this.outerDragDisabled||(this.castDisabled=!1,this.recharging=!1,this.bufferedCastAvailable=!1)},duration:1800*gameVars.gameManualSlowSpeed,rotation:"+=6.283"}),this.scene.tweens.add({targets:this.outerCircle,delay:0,easeParams:[1.1],ease:"Back.easeIn",onComplete:()=>{this.resetEmbodiments(),this.outerDragDisabled=!1,this.innerDragDisabled||this.outerDragDisabled||(this.castDisabled=!1,this.recharging=!1,this.bufferedCastAvailable=!1)},duration:1800*gameVars.gameManualSlowSpeed,rotation:"-=6.283"}))}manualResetElements(e,t=!1){!this.innerDragDisabled&&(this.manuallyResettingElements=!0,this.innerDragDisabled=!0,this.castDisabled=!0,this.recharging=!0,this.lastDragTime=-1e3,this.elementHighlight.visible=!1,this.embodimentHighlight.visible=!1,t&&(this.spellNameText.visible=!1,this.spellElementText.setText(""),this.spellActionText.setText(""),this.clearSpellDescriptorText(),this.spellDescriptor.stopNextAudio()),this.scene.tweens.add({targets:this.innerCircle,ease:"Back.easeIn",easeParams:[t?.9:1.1],onComplete:()=>{this.resetElements(e),this.innerDragDisabled=!1},duration:gameVars.gameManualSlowSpeed*t?2100:1200,rotation:t?"+=12.566":"+=6.283"}))}resetElements(e){this.lastDragTime=0;for(let t=0;t<this.elements.length;t++)e&&e==this.elements[t]||(this.elements[t].glow.visible=!0,this.elements[t].burnedOut=!1);this.elementHighlight.visible=!1,this.embodimentHighlight.visible=!1;let i=this.elemCircle;i||(this.elemCircle=this.scene.add.sprite(this.x,this.y,"circle","circle.png"),(i=this.elemCircle).setDepth(131)),i.setScale(.8).setAlpha(1),this.innerCircle.prevRotation=this.innerCircle.rotation,this.innerCircle.nextRotation=this.innerCircle.rotation,this.scene.tweens.add({targets:i,alpha:0,scaleX:1,scaleY:1,duration:500*gameVars.gameManualSlowSpeed})}manualResetEmbodiments(e,t=!1){!this.outerDragDisabled&&(this.outerDragDisabled=!0,this.castDisabled=!0,this.disableSpellDescDisplay=!0,this.recharging=!0,this.lastDragTime=-1e3,this.elementHighlight.visible=!1,this.embodimentHighlight.visible=!1,PhaserScene.time.delayedCall(250*gameVars.gameManualSlowSpeed,()=>{this.bufferedCastAvailable=!0}),this.scene.tweens.add({targets:this.outerCircle,ease:"Back.easeIn",easeParams:[t?1.1:1.25],onComplete:()=>{this.resetEmbodiments(e),this.outerDragDisabled=!1,setTimeout(()=>{if(!this.outerDragDisabled){t&&(this.disableSpellDescDisplay=!1),this.castDisabled=!1,this.recharging=!1,this.bufferedCastAvailable=!1,this.useBufferedSpellCast&&this.castSpell(!0),this.readySprite?(this.readySprite.visible=!0,this.readySprite.play(t?"circleEffect":"circleEffectSmall"),this.readySprite.setScale(1.1)):this.readySprite=this.scene.add.sprite(this.x,this.y,"circle").play("circleEffect").setScale(1.1).setDepth(1e3),this.readySprite.setAlpha(1);let e=gameVars.gameManualSlowSpeed*(t?1200:900);this.scene.tweens.add({targets:this.readySprite,scaleX:t?2.63:2.57,scaleY:t?2.63:2.57,duration:e,ease:"Cubic.easeOut",onComplete:()=>{this.readySprite.visible=!1}}),this.scene.tweens.add({targets:this.readySprite,alpha:0,duration:e,ease:"Quad.easeIn"})}},t?800:0)},duration:gameVars.gameManualSlowSpeed*t?2100:1200,rotation:t?"+=12.566":"+=6.283"}))}resetEmbodiments(e){this.lastDragTime=0;for(let t=0;t<this.embodiments.length;t++)e&&e==this.embodiments[t]||(this.embodiments[t].glow.visible=!0,this.embodiments[t].burnedOut=!1);this.elementHighlight.visible=!1,this.embodimentHighlight.visible=!1;let i=this.embodiCircle;i||(this.embodiCircle=this.scene.add.sprite(this.x,this.y,"circle","circle.png"),(i=this.embodiCircle).setDepth(130)),i.setAlpha(0).setScale(1.05),messageBus.publish("wheelReloaded"),this.outerCircle.prevRotation=this.outerCircle.rotation,this.outerCircle.nextRotation=this.outerCircle.rotation,this.scene.tweens.add({targets:i,alpha:0,scaleX:1.2,scaleY:1.2,duration:500*gameVars.gameManualSlowSpeed,completeDelay:500,onComplete(){}})}createElementCast(e){let t=e.runeName,i=this.elementsAnimArray[t];if(!i||!1===i.canUse){let s=i&&i.canUse;(i=this.scene.add.sprite(0,-999,"circle","bright_"+t+".png")).setOrigin(.5,.14),s||(this.elementsAnimArray[t]=i),i.setDepth(130),i.shouldDelete=s}i.canUse=!1;let a=poolManager.getItemFromPool("castCircle");a||(a=this.scene.add.sprite(this.x,this.y-100,"circle","cast_circle.png")).setDepth(130),a.alpha=0,a.setScale(1.25),a.rotation=0,i.setPosition(this.x+133*Math.sin(e.rotation),this.y-133*Math.cos(e.rotation)),i.setAlpha(1),a.setPosition(i.x,i.y+21),i.setScale(1.2),this.scene.tweens.add({targets:i,duration:100*gameVars.gameManualSlowSpeed,ease:"Cubic.easeOut",scaleX:isMobile?1.5:1.4,scaleY:isMobile?1.5:1.4,y:"-=6",onComplete:()=>{this.scene.tweens.add({targets:i,ease:"Cubic.easeOut",y:"+=9",duration:350*gameVars.gameManualSlowSpeed,scaleX:isMobile?1.075:1.05,scaleY:isMobile?1.075:1.05})}}),this.scene.tweens.add({targets:a,duration:250*gameVars.gameManualSlowSpeed,alpha:.95}),this.scene.tweens.add({targets:a,ease:"Cubic.easeIn",duration:220*gameVars.gameManualSlowSpeed,scaleX:1,scaleY:1,onComplete:()=>{a.alpha=1,this.scene.tweens.add({targets:a,duration:650*gameVars.gameManualSlowSpeed,delay:30,ease:"Quart.easeInOut",rotation:-1.57,alpha:.55}),this.scene.tweens.add({targets:[a],ease:"Quart.easeInOut",delay:60,duration:800*gameVars.gameManualSlowSpeed,x:this.x-28,y:this.y-246}),this.scene.tweens.add({targets:[i],ease:"Quart.easeInOut",delay:60,duration:800*gameVars.gameManualSlowSpeed,x:this.x-28,y:this.y-262,onComplete:()=>{this.scene.tweens.add({targets:[i,a],alpha:0,scaleX:1.5,scaleY:1.5,y:"-=2",x:"-=2",ease:"Cubic.easeOut",duration:600*gameVars.gameManualSlowSpeed,onComplete(){poolManager.returnItemToPool(a,"castCircle"),i.shouldDelete?i.destroy():(i.setScale(1),i.canUse=!0)}})}})}})}createEmbodimentCast(e,t){let i=e.runeName,s=this.embodimentsAnimArray[i];if(!s||!1===s.canUse){let a=s&&s.canUse;(s=this.scene.add.sprite(0,-999,"circle","bright_"+i+".png")).setOrigin(.5,.14),a||(this.embodimentsAnimArray[i]=s),s.setDepth(130),s.shouldDelete=a}let l="rune_strike"===i;s.canUse=!1;let r=poolManager.getItemFromPool("castCircle");r||(r=this.scene.add.sprite(this.x,this.y-100,"circle","cast_circle.png")).setDepth(130),r.alpha=0,r.setScale(1.25),r.rotation=0,s.setPosition(this.x+196*Math.sin(e.rotation),this.y-197*Math.cos(e.rotation)),s.setAlpha(1),r.setPosition(s.x,s.y+18),s.setScale(1.2),this.scene.tweens.add({targets:s,y:"-=9",duration:100*gameVars.gameManualSlowSpeed,ease:"Cubic.easeOut",scaleX:isMobile?1.55:1.44,scaleY:isMobile?1.55:1.44,completeDelay:isMobile?50:0,onComplete:()=>{this.scene.tweens.add({targets:s,ease:"Cubic.easeOut",y:"+=9",duration:350*gameVars.gameManualSlowSpeed,scaleX:isMobile?1.075:1.05,scaleY:isMobile?1.075:1.05})}}),this.scene.tweens.add({targets:r,duration:250*gameVars.gameManualSlowSpeed,alpha:.95}),this.focusLinesOn.currAnim&&this.focusLinesOn.currAnim.stop(),this.focusLinesOn.setFrame("focus_lines_glow.png"),this.focusLinesOn.alpha=1,this.scene.tweens.add({targets:this.focusLinesOn,duration:325*gameVars.gameManualSlowSpeed,ease:"Quart.easeIn",alpha:0,onComplete:()=>{this.focusLinesOn.setFrame("focus_lines_on.png")}}),this.scene.tweens.add({targets:r,ease:"Cubic.easeIn",duration:220*gameVars.gameManualSlowSpeed,scaleX:1,scaleY:1,onComplete:()=>{r.alpha=1,this.scene.tweens.add({targets:r,duration:650*gameVars.gameManualSlowSpeed,delay:30,ease:"Quart.easeInOut",rotation:1.57,alpha:.55});let e=this.keyboardCasted?100:0,a=l?100:0,n=this.keyboardCasted?200:0;PhaserScene.time.delayedCall(gameVars.gameManualSlowSpeed*e,()=>{this.forcingAlignment=!1}),this.scene.tweens.add({targets:s,delay:60,rotation:0,duration:750*gameVars.gameManualSlowSpeed,onComplete:()=>{let e=this.outerDragDisabled?650:0;this.focusLinesOn.currAnim=this.scene.tweens.add({delay:n+e+a,targets:this.focusLinesOn,duration:150*gameVars.gameManualSlowSpeed,alpha:.65,ease:"Cubic.easeIn",onComplete:()=>{this.focusLinesOn.setAlpha(1),this.focusLinesOn.currAnim=this.scene.tweens.add({targets:this.focusLinesOn,duration:200*gameVars.gameManualSlowSpeed,alpha:.94,onComplete:()=>{this.focusLinesOn.currAnim=null}})}})}}),this.scene.tweens.add({targets:[r],ease:"Quart.easeInOut",delay:60,duration:800*gameVars.gameManualSlowSpeed,x:this.x+28,y:this.y-246}),this.scene.tweens.add({targets:[s],ease:"Quart.easeInOut",delay:60,duration:800*gameVars.gameManualSlowSpeed,x:this.x+28,y:this.y-262,onComplete:()=>{t(),PhaserScene.time.delayedCall(230*gameVars.gameManualSlowSpeed,()=>{this.bufferedCastAvailable=!0}),PhaserScene.time.delayedCall(gameVars.gameManualSlowSpeed*(25+n+a),()=>{this.outerDragDisabled||(this.castDisabled=!1),"center"===gameOptions.infoBoxAlign&&(this.disableSpellDescDisplay=!0),this.spellNameTextAnim&&this.spellNameTextAnim.stop();let e=0;("rune_strike"===i||"rune_ultimate"===i)&&(e=400),this.spellNameTextAnim=this.scene.tweens.add({targets:[this.spellNameText,this.spellActionText,this.spellElementText],delay:1e3+e,alpha:.55,duration:150*gameVars.gameManualSlowSpeed,onStart:()=>{this.disableSpellDescDisplay=!1,this.spellDescriptor.addTween({ease:"Cubic.easeInOut",alpha:"center"===gameOptions.infoBoxAlign?.9:.98,duration:150*gameVars.gameManualSlowSpeed})}}),this.bufferedCastAvailable=!1,this.useBufferedSpellCast&&this.castSpell(!0)}),this.scene.tweens.add({targets:[r],alpha:0,scaleX:1.5,scaleY:1.5,x:"+=2",y:"-=2",ease:"Cubic.easeOut",duration:600*gameVars.gameManualSlowSpeed,onComplete(){poolManager.returnItemToPool(r,"castCircle"),s.shouldDelete?s.destroy():(s.setScale(1),s.canUse=!0)}}),this.scene.tweens.add({targets:[s],alpha:0,scaleX:1.5,scaleY:1.5,x:"+=2",y:"-=6",ease:"Cubic.easeOut",duration:600*gameVars.gameManualSlowSpeed,onComplete(){s.shouldDelete?s.destroy():(s.setScale(1),s.canUse=!0)}})}})}})}showReadySprite(e=!0,t=1){if(this.readySprite){this.readySprite.currAnim&&this.readySprite.currAnim.stop(),this.readySprite.setAlpha(1),this.readySprite.setScale(1.15*t),this.readySprite.play(e?"circleEffect":"circleEffectSmall"),this.readySprite.visible=!0;let i=(e?1.8:1.75)*t;this.readySprite.currAnim=this.scene.tweens.add({targets:this.readySprite,scaleX:i,scaleY:i,duration:gameVars.gameManualSlowSpeed*e?800:650,ease:"Cubic.easeOut",onComplete:()=>{this.readySprite.visible=!1}})}}trueCastSpell(e,t,i=-1,s){messageBus.publish("castSpell",e,t,-1!=i?"shield"+i:"undefinedShield",s)}setAuraAlpha(e=0){this.aura.alpha=e}flashElement(e){this.playErrorSfxCooldown||(playSound("fizzle",.8),this.playErrorSfxCooldown=!0,setTimeout(()=>{this.playErrorSfxCooldown=!1},300)),e.setAlpha(.25),e.setScale(.98),this.scene.tweens.add({targets:e,ease:"Cubic.easeIn",scaleX:1.02,scaleY:1.02,onComplete:()=>{this.scene.tweens.add({targets:e,ease:"Cubic.easeOut",duration:gameVars.gameManualSlowSpeed*isMobile?750:600,scaleX:1,scaleY:1,alpha:0})},duration:50*gameVars.gameManualSlowSpeed,alpha:isMobile?.8:.7})}getDelayedDamageClockScale(){let e=Math.max(0,Math.floor((this.delayedDamage-1)/this.delayedDamageBase));return .5+.1*(Math.sqrt(.5*e)+.2*e)}plainUpdateDelayedDamageVisual(e){this.delayDamageHourglass.setScale(e-.1);let t=Math.floor(Math.max(0,this.delayedDamage-.5)/this.delayedDamageBase)*this.delayedDamageBase;t>0?(this.delayDamageSandFull.alpha=1,this.delayDamageSandFull.setScale(e-.28)):this.delayDamageSandFull.setScale(0);let i=(this.delayedDamage-t)/this.delayedDamageBase*6.283-1.5708,s=this.delayDamageHourglass.x,a=this.delayDamageHourglass.y,l=98*this.delayDamageHourglass.scaleX;this.delayDamagePartial.visible=!0,this.delayDamagePartial.canCleanup=!0,this.delayDamagePartial.clear(),this.delayDamagePartial.slice(s,a,l,-1.5708,i,!1),this.delayDamagePartial.fillPath()}clearClock(){this.delayDamagePartial&&this.delayDamagePartial.canCleanup&&(this.delayDamagePartial.clear(),this.delayDamagePartial.canCleanup=!1),this.scene.tweens.add({delay:100,targets:[this.delayDamageHourglass,this.delayDamageSandFull,this.delayDamageText],ease:"Back.easeIn",scaleX:0,scaleY:0,duration:400*gameVars.gameManualSlowSpeed,alpha:0})}handleStatusesTicked(){if(this.delayedDamage>0){if(this.delayedDamageRecentlyAdded){this.delayedDamageRecentlyAdded=!1;return}if(this.delayedDamageShouldTick){this.tickDelayedDamage();let e=this.getDelayedDamageClockScale();this.plainUpdateDelayedDamageVisual(e),this.delayedDamage<=this.delayedDamageBase&&(this.delayedDamageShouldTick=!1),this.delayedDamage<=0&&this.clearClock()}else this.delayedDamageShouldTick=!0}}tickDelayedDamage(e=1){globalObjects.currentEnemy&&!globalObjects.currentEnemy.dead&&(this.delayedDamage-=e,globalObjects.player.recentlyTakenDelayedDamageAmt>0&&(globalObjects.player.recentlyTakenDelayedDamageAmt-=e,globalObjects.player.recentlyTakenDamageAmt+=e),this.delayDamageText.setText(this.delayedDamage),messageBus.publish("selfTakeTrueDamage",e))}getDelayedDamage(){return this.delayedDamage}enableVoidArm(e,t,i){let s=i>1.3,a=gameVars.gameManualSlowSpeed*e;this.voidArm.setScale(s?.95*i:1.15*i),this.scene.tweens.add({targets:this.voidArm,delay:a,duration:gameVars.gameManualSlowSpeed*(t-900),y:210,onComplete:()=>{this.scene.tweens.add({targets:this.voidArm,alpha:0,duration:400*gameVars.gameManualSlowSpeed,ease:"Cubic.easeIn"})}}),this.scene.tweens.add({targets:this.voidArm,delay:a,duration:350*gameVars.gameManualSlowSpeed,ease:s?"Back.easeOut":"Quad.easeOut",easeParams:[5],alpha:1,scaleX:i,scaleY:i}),s&&(this.voidArm2.setScale(s?.95*i:1.15*i),this.scene.tweens.add({targets:this.voidArm2,delay:a,duration:gameVars.gameManualSlowSpeed*(t-900),y:210,onComplete:()=>{this.scene.tweens.add({targets:this.voidArm2,alpha:0,duration:400*gameVars.gameManualSlowSpeed,ease:"Cubic.easeIn"})}}),this.scene.tweens.add({targets:this.voidArm2,delay:a,duration:350*gameVars.gameManualSlowSpeed,ease:"Back.easeOut",easeParams:[5],alpha:1,scaleX:i,scaleY:i}))}addDelayedDamage(e){if(!globalObjects.currentEnemy||globalObjects.currentEnemy.dead)return;let t=this.delayedDamage;if(this.delayedDamage+=e,this.delayedDamageRecentlyAdded=!0,globalObjects.player.canResetRecentDamage&&(globalObjects.player.canResetRecentDamage=!1,globalObjects.player.resetRecentDamage(),globalObjects.player.recentlyTakenDelayedDamageAmt=0,globalObjects.player.lastInjuryHealth=globalObjects.player.health),globalObjects.player.addRecentlyTakenDelayedDamage(e),this.delayedDamage>0){this.delayDamageText.setText(this.delayedDamage);let i=this.getDelayedDamageClockScale(),s=.75*Math.sqrt(2*i);if(t<=0){this.delayDamageHourglass.setScale(i-.4),this.delayDamageText.setScale(s-.3),this.delayDamageHourglass.setRotation(.5),this.delayDamageHourglass.setAlpha(.5),this.delayDamageText.setAlpha(.5);let a=this.delayedDamage/this.delayedDamageBase*6.283-1.5708,l=this.delayDamageHourglass.x,r=this.delayDamageHourglass.y;this.delayDamagePartial.visible=!0,this.delayDamagePartial.clear(),this.delayDamagePartial.slice(l,r,98*(i-.1),-1.5708,a,!1),this.delayDamagePartial.fillPath(),this.scene.tweens.add({targets:[this.delayDamagePartial],duration:400*gameVars.gameManualSlowSpeed,alpha:1});let n=[this.delayDamageHourglass,this.delayDamageText];this.delayedDamage>this.delayedDamageBase&&(this.delayDamageSandFull.setScale(this.delayDamageHourglass.scaleX-.175),n.push(this.delayDamageSandFull)),this.scene.tweens.add({targets:n,ease:"Cubic.easeOut",rotation:0,scaleX:"+= 0.3",scaleY:"+= 0.3",duration:400*gameVars.gameManualSlowSpeed,alpha:1,onComplete:()=>{let e=this.getDelayedDamageClockScale();this.plainUpdateDelayedDamageVisual(e)}})}else{this.scene.tweens.add({targets:[this.delayDamageText],ease:"Cubic.easeOut",rotation:0,scaleX:s,scaleY:s,duration:250*gameVars.gameManualSlowSpeed,alpha:1});let h=this.getDelayedDamageClockScale();this.plainUpdateDelayedDamageVisual(h)}}return this.delayedDamage}reduceDelayedDamage(e){if(this.delayedDamage=Math.max(0,this.delayedDamage-e),e>0&&messageBus.publish("animateHealNum",this.delayDamageText.x-1,this.delayDamageText.y-50,"+"+e,.5+Math.min(1.25,.5+.2*Math.sqrt(Math.abs(e)))),this.delayedDamage<=0)this.removeDelayedDamage();else{this.delayDamageText.setText(this.delayedDamage);let t=this.getDelayedDamageClockScale();this.plainUpdateDelayedDamageVisual(t)}}removeDelayedDamage(){this.delayedDamage=0,this.delayDamageText.setText(this.delayedDamage),this.clearClock()}setTempRotObjs(e,t){this.tempRotObjs=e,this.tempLockRot=t}updateSpellDescriptorText(e){if(this.spellDescriptor.getText()!==e){if(this.disableSpellDescDisplay||this.manualDisabled||globalObjects.bannerTextManager.isShowing){this.clearSpellDescriptorText(),this.spellDescriptor.stopNextAudio();return}if(!this.spellDescriptor.getStopNextAudio()){let t=Date.now(),i=0,s=1,a=t-this.lastPlayedClickTime;a>25&&(a<1e3&&(s=.8+.001*(i=Math.floor((a-900-Math.floor(100*Math.random()))*.5))),playSound("click",s).detune=i,this.lastPlayedClickTime=Date.now())}messageBus.publish("spellNameTextUpdate",e),this.spellDescriptor.setText(e),"center"===gameOptions.infoBoxAlign&&(this.spellDescriptor.isMultiLine()?(this.spellElementText.y=this.spellElementText.startY-15,this.spellNameText.y=this.spellNameText.startY-15,this.spellActionText.y=this.spellActionText.startY-15):(this.spellElementText.y=this.spellElementText.startY,this.spellNameText.y=this.spellNameText.startY,this.spellActionText.y=this.spellActionText.startY))}}clearSpellDescriptorText(){""!==this.spellDescriptor.getText()&&(this.spellDescriptor.setText(""),this.showRunes||this.spellNameText.setText(""),"center"===gameOptions.infoBoxAlign&&(this.spellElementText.y=this.spellElementText.startY,this.spellNameText.y=this.spellNameText.startY,this.spellActionText.y=this.spellActionText.startY))}updateSpellHover(e,t,i,s){let a=globalObjects.player.spellMultiplier(),l="";a>1.1&&(l=" X"+a);let r=!1;"left"===gameOptions.infoBoxAlign?(this.disableSpellDescDisplay||this.manualDisabled||globalObjects.bannerTextManager.isShowing)&&(this.clearSpellDescriptorText(),this.spellDescriptor.stopNextAudio(),r=!0):(this.castDisabled||this.disableSpellDescDisplay||this.manualDisabled||globalObjects.bannerTextManager.isShowing)&&(this.clearSpellDescriptorText(),this.spellDescriptor.stopNextAudio(),r=!0);let n="";if(!r)switch(t.runeName){case RUNE_STRIKE:n="STRIKE";break;case RUNE_REINFORCE:n="BODY";break;case RUNE_ENHANCE:n="ENHANCE";break;case RUNE_PROTECT:n="SHIELD";break;case RUNE_UNLOAD:n="ULTIMATE"}let h="center"===gameOptions.infoBoxAlign?"_long":"";if(!r){if(e.runeName&&t.runeName){let o=e.runeName+"_"+t.runeName;this.spellNameText.setText(getBasicText(o))}else this.spellNameText.setText("");switch(e.runeName){case RUNE_MATTER:switch(this.spellElementText.setText("MATTER"),t.runeName){case RUNE_STRIKE:gameVars.matterPlus?this.updateSpellDescriptorText(getLangText("matter_strike_plus_desc"+h)):this.updateSpellDescriptorText(getLangText("matter_strike_desc"+h));break;case RUNE_REINFORCE:n+=a>1.1?" X"+a:"",this.updateSpellDescriptorText(getLangText("matter_reinforce_desc"+h));break;case RUNE_ENHANCE:n+=a>1.1?" X"+a:"",this.updateSpellDescriptorText(getLangText("matter_enhance_desc"+h));break;case RUNE_PROTECT:n+=a>1.1?" X"+a:"",this.updateSpellDescriptorText(getLangText((gameVars.matterPlus?"matter_protect_plus_desc":"matter_protect_desc")+h));break;case RUNE_UNLOAD:n+=a>1.1?" X"+a:"",this.updateSpellDescriptorText(getLangText("matter_unload_desc"+h));break;default:this.clearSpellDescriptorText()}break;case RUNE_TIME:switch(this.spellElementText.setText("TIME"),t.runeName){case RUNE_STRIKE:this.updateSpellDescriptorText(getLangText("time_strike_desc"+h));break;case RUNE_REINFORCE:let d=1-.5**a,c=globalObjects.player.getSelfHealAmt(d),$=Math.min(globalObjects.player.lastInjuryHealth-globalObjects.player.health,globalObjects.player.recentlyTakenDamageAmt*d);n+=" (\\"+c+")",this.updateSpellDescriptorText(getLangText("time_reinforce_desc"+h)),$>1&&globalObjects.player.flashRecentInjury(!1,$,!0);break;case RUNE_ENHANCE:n+=a>1.1?" X"+a:"",this.updateSpellDescriptorText(getLangText("time_enhance_desc"+h));break;case RUNE_PROTECT:n+=a>1.1?" X"+a:"",this.updateSpellDescriptorText(getLangText("time_protect_desc"+h));break;case RUNE_UNLOAD:let m=0,u=a;for(;u>0;)u--,m+=Math.max(3,7-globalObjects.player.getPlayerTimeExhaustion()-u);this.updateSpellDescriptorText(getLangText("time_unload_desc"+h)+m+getLangText("time_unload_desc_2"+h));break;default:this.clearSpellDescriptorText()}break;case RUNE_MIND:switch(this.spellElementText.setText("ENERGY"),t.runeName){case RUNE_STRIKE:this.updateSpellDescriptorText(getLangText("mind_strike_desc"+h));break;case RUNE_REINFORCE:n+=a>1.1?" X"+a:"",this.updateSpellDescriptorText(getLangText("mind_reinforce_desc"+h));break;case RUNE_ENHANCE:n+=a>1.1?" X"+a:"",gameVars.mindPlus?this.updateSpellDescriptorText(getLangText("mind_enhance_plus_desc"+h)):this.updateSpellDescriptorText(getLangText("mind_enhance_desc"+h));break;case RUNE_PROTECT:n+=a>1.1?" X"+a:"",this.updateSpellDescriptorText(getLangText("mind_protect_desc"+h));break;case RUNE_UNLOAD:n+="",this.updateSpellDescriptorText(getLangText("mind_unload_desc"+h));break;default:this.clearSpellDescriptorText()}break;case RUNE_VOID:switch(this.spellElementText.setText("VOID"),t.runeName){case RUNE_STRIKE:this.updateSpellDescriptorText(getLangText("void_strike_desc"+h));break;case RUNE_ENHANCE:n+=a>1.1?" X"+a:"",this.updateSpellDescriptorText(getLangText("void_enhance_desc"+h));break;case RUNE_PROTECT:n+=a>1.1?" X"+a:"",this.updateSpellDescriptorText(getLangText("void_protect_desc"+h));break;case RUNE_REINFORCE:n+=a>1.1?" X"+a:"",this.updateSpellDescriptorText(getLangText("void_reinforce_desc"+h));break;case RUNE_UNLOAD:this.updateSpellDescriptorText(getLangText("void_unload_desc"+h));break;default:this.clearSpellDescriptorText()}break;default:this.spellElementText.setText(""),this.clearSpellDescriptorText()}}this.showRunes?""===this.spellElementText.text&&""===this.spellActionText.text?this.spellNameText.visible=!1:this.spellNameText.visible=!0:""===this.spellElementText.text||""===this.spellActionText.text?this.spellNameText.visible=!1:this.spellNameText.visible=!0,globalObjects.currentEnemy&&!globalObjects.currentEnemy.isDestroyed&&!globalObjects.currentEnemy.dead&&(this.spellNameText.visible?""!==n&&e.runeName&&("STRIKE"===n?e.runeName===RUNE_VOID?globalObjects.currentEnemy.setPredictScale(37.5):globalObjects.currentEnemy.setPredictScale(23):"ULTIMATE"===n?e.runeName===RUNE_MATTER&&globalObjects.currentEnemy.setPredictScale(23):globalObjects.currentEnemy.setPredictScale()):globalObjects.currentEnemy.setPredictScale(0)),this.spellActionText.setText(n),(this.castDisabled||this.manualDisabled)&&(this.spellNameText.visible=!1,this.spellElementText.setText(""),this.spellActionText.setText(""))}applyMindBurn(e=5,t=1){if(!globalObjects.currentEnemy||globalObjects.currentEnemy.dead)return;this.mindBurnTween&&this.mindBurnTween.stop(),this.mindBurnAnim.alpha=.5;let i=(gameVars.mindPlus?3:2)*t;this.mindBurnAnim.setScale(.55+.05*Math.sqrt(e)+.05*i),this.flashBGWhite||(this.flashBGWhite=PhaserScene.add.image(gameConsts.halfWidth,gameConsts.halfHeight-200,"blurry","circle.webp").setDepth(-1).setAlpha(0));let s=2+.02*e;this.flashBGWhite.setScale(s),this.scene.tweens.add({targets:this.flashBGWhite,alpha:.005*e-.02,scaleX:1.2*s,scaleY:1.2*s,duration:120*gameVars.gameManualSlowSpeed,ease:"Cubic.easeOut",onComplete:()=>{this.scene.tweens.add({targets:this.flashBGWhite,alpha:0,duration:250*gameVars.gameManualSlowSpeed+10*e,ease:"Cubic.easeOut"})}}),messageBus.publish("showCircleShadow",.03+.005*e,-90+20*e),this.mindBurnAnim.currAnim&&this.mindBurnAnim.currAnim.stop(),this.animateMindBurn(5,i),messageBus.publish("enemyOnFire",5)}animateMindBurn(e,t){this.mindBurnAnim.setScale(.75+.052*t),this.mindBurnAnim.alpha=.9,messageBus.publish("enemyTakeTrueDamage",t,!1,0,!0),messageBus.publish("addCastAggravate",.85*Math.max(0,t+1),!1,0,!0),e<=1?this.mindBurnAnim.currAnim=PhaserScene.tweens.add({targets:[this.mindBurnAnim],alpha:0,scaleX:1+.05*t,scaleY:1+.05*t,duration:250,ease:"Quad.easeOut"}):this.mindBurnAnim.currAnim=this.scene.tweens.add({targets:this.mindBurnAnim,alpha:.42,duration:500,scaleX:.65+.05*t,scaleY:.65+.05*t,completeDelay:500,onComplete:()=>{this.animateMindBurn(e-1,t)}})}applyVoidBurn(e=1,t=5,i){if(!globalObjects.currentEnemy)return;let s=.7+.1*Math.sqrt(e);this.voidSliceImage1.visible=!0,this.voidSliceImage3.visible=!0,this.voidSliceImage1.alpha=.75,this.voidSliceImage3.alpha=.75,this.voidSliceImage1.setScale(.4*s,.95*s),this.voidSliceImage3.setScale(.4*s,.95*s),this.scene.tweens.add({targets:[this.voidSliceImage1,this.voidSliceImage3],ease:"Cubic.easeOut",scaleX:.8*s,scaleY:.8*s,alpha:.45,duration:150*gameVars.gameManualSlowSpeed}),this.voidSliceImage1.anim&&(this.currVoidAnim.remove(),this.voidSliceImage1.anim.stop(),this.voidSliceImage3.anim.stop()),this.voidSliceImage1.anim=this.scene.tweens.add({delay:100,targets:this.voidSliceImage1,scaleX:.5*s,scaleY:.95*s,alpha:.65,ease:"Quad.easeOut",duration:1e3*gameVars.gameManualSlowSpeed}),this.voidSliceImage3.anim=this.scene.tweens.add({delay:100,targets:this.voidSliceImage3,scaleX:.45*s,scaleY:1*s,alpha:.7,ease:"Quad.easeOut",duration:2e3*gameVars.gameManualSlowSpeed}),this.currVoidAnim=PhaserScene.time.delayedCall(1100,()=>{this.fireVoidSpike(this.voidSliceImage1,s,e),this.currVoidAnim=PhaserScene.time.delayedCall(700,()=>{if(this.fireVoidSpike(this.voidSliceImage3,s,e),i){let t=getTempPoolObject("tutorial","rune_void_large.png","specialAttack",1300);t.setAlpha(.05).setDepth(999).setScale(5).setPosition(gameConsts.halfWidth,this.voidSliceImage3.y-42).setRotation(-3),playSound("void_body"),this.scene.tweens.add({targets:t,duration:125,alpha:1}),this.scene.tweens.add({targets:t,duration:1250,rotation:0,ease:"Quart.easeOut"}),this.scene.tweens.add({targets:t,duration:125,scaleX:3.2,scaleY:3.2,ease:"Quint.easeIn",onComplete:()=>{zoomTemp(1.02),screenShake(3),messageBus.publish("setSlowMult",.25,15),this.scene.tweens.add({delay:200,targets:t,duration:900,alpha:0,ease:"Cubic.easeOut"}),this.scene.tweens.add({delay:200,targets:t,duration:900,scaleX:4,scaleY:4,ease:"Cubic.easeIn"})}})}})})}fireVoidSpike(e,t,i){e.anim&&e.anim.stop(),e.alpha=1,playSound("void_strike",.3),PhaserScene.time.delayedCall(100*gameVars.gameManualSlowSpeed,()=>{messageBus.publish("enemyTakeDamage",i,!0,void 0,"void"),messageBus.publish("setPauseDur",30)}),e.setScale(4*t,.6*t),this.scene.tweens.add({delay:1,targets:e,ease:"Quart.easeOut",scaleX:1.9*t,scaleY:.75*t,duration:100*gameVars.gameManualSlowSpeed,onComplete:()=>{this.scene.tweens.add({delay:100,targets:e,ease:"Cubic.easeIn",scaleX:t,scaleY:0,duration:150*gameVars.gameManualSlowSpeed})}})}handleVoidForm(){this.castDisabled=!0,this.bufferedCastAvailable=!1,this.outerDragDisabled=!0,this.innerDragDisabled=!0,this.lastDragTime=Math.min(this.lastDragTime,-9999),gameVars.playerNotMoved=!1,this.disableSpellDescDisplay=!0,this.removeDelayedDamage()}clearVoidForm(){this.castDisabled=!1,this.outerDragDisabled=!1,this.innerDragDisabled=!1,this.lastDragTime=0,this.disableSpellDescDisplay=!1}clearMindForm(e){}clearEffects(e){!e&&(this.voidSliceImage1.visible=!1,this.voidSliceImage3.visible=!1,this.mindBurnAnim.alpha=0,this.removeDelayedDamage())}disableMovement(){this.greyed.visible=!0,this.manualDisabled=!0,this.disableSpellDescDisplay=!0}enableMovement(){this.greyed.visible=!1,this.manualDisabled=!1,this.disableSpellDescDisplay=!1}playerDied(){this.removeDelayedDamage(),this.disableMovement(),this.greyedDead.visible=!0,this.greyedDead.alpha=1,this.disappearDeath&&this.disappearDeath.stop()}playerRevived(){this.enableMovement(),this.disappearDeath=this.scene.tweens.add({targets:this.greyedDead,alpha:0,duration:250*gameVars.gameManualSlowSpeed})}highlightRunes(){if(this.errorBoxElement.setDepth(1e4),this.errorBoxEmbodiment.setDepth(1e4),this.elements)for(let e=0;e<this.elements.length;e++)this.elements[e].glow.setDepth(1e4);if(this.embodiments)for(let t=0;t<this.embodiments.length;t++)this.embodiments[t].glow.setDepth(1e4)}unhighlightRunes(){if(this.errorBoxElement.setDepth(121),this.errorBoxEmbodiment.setDepth(121),this.elements)for(let e=0;e<this.elements.length;e++)this.elements[e].glow.setDepth(103);if(this.embodiments)for(let t=0;t<this.embodiments.length;t++)this.embodiments[t].glow.setDepth(103)}showCircleShadow(e=.25,t=0,i=99999){this.shadowCircle.setDepth(i),this.shadowCircle.alpha=e,this.shadowCircle.currAnim&&this.shadowCircle.currAnim.stop(),this.shadowCircle.currAnim=this.scene.tweens.add({targets:this.shadowCircle,alpha:0,ease:"Cubic.easeIn",duration:950*gameVars.gameManualSlowSpeed+1e3*e+t})}setCircleShadow(e=.2){this.shadowCircle.alpha=e}refreshHoverText(){"center"===gameOptions.infoBoxAlign?(this.spellDescriptor.setOrigin(.48,1),this.spellDescriptor.setPosition(gameConsts.halfWidth,isMobile?gameConsts.height-366:gameConsts.height-358),this.spellDescriptor.setAlign("center"),this.spellDescriptor.setAlpha(.9),this.spellElementText.y=this.spellElementText.startY,this.spellNameText.y=this.spellNameText.startY,this.spellActionText.y=this.spellActionText.startY):"none"===gameOptions.infoBoxAlign?(this.spellDescriptor.setPosition(-9999,0),this.spellElementText.y=this.y-249,this.spellNameText.y=this.y-249,this.spellActionText.y=this.y-249):"left"===gameOptions.infoBoxAlign&&(this.spellDescriptor.setOrigin(0,1),this.spellDescriptor.setPosition(0,gameConsts.height-310),this.spellDescriptor.setAlign("left"),this.spellDescriptor.setAlpha(.98),this.spellElementText.y=this.y-249,this.spellNameText.y=this.y-249,this.spellActionText.y=this.y-249)}}

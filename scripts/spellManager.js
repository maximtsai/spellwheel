class SpellManager{constructor(e){this.scene=e,this.particlesRock=[],messageBus.subscribe("castSpell",this.handleSpell.bind(this)),this.initializePoolStuff()}initializePoolStuff(){let e=this.scene.add.image(0,0,"spells","rock.png");poolManager.returnItemToPool(e,"rock")}handleSpell(e,t,a,s=0){switch(e.runeName){case RUNE_MATTER:switch(t.runeName){case RUNE_STRIKE:this.castMatterStrike();break;case RUNE_REINFORCE:this.castMatterReinforce();break;case RUNE_ENHANCE:this.castMatterEnhance();break;case RUNE_PROTECT:this.castMatterProtect(a,s);break;case"rune_superprotect":this.castMatterProtect(a,s,!0);break;case RUNE_UNLOAD:this.castMatterUltimate()}break;case RUNE_TIME:switch(t.runeName){case RUNE_STRIKE:this.castTimeStrike();break;case RUNE_REINFORCE:this.castTimeReinforce();break;case RUNE_ENHANCE:this.castTimeEnhance();break;case RUNE_PROTECT:this.castTimeProtect(a,s);break;case RUNE_UNLOAD:this.castTimeUltimate()}break;case RUNE_MIND:switch(t.runeName){case RUNE_STRIKE:this.castMindStrike();break;case RUNE_REINFORCE:this.castMindReinforce();break;case RUNE_ENHANCE:this.castMindEnhance();break;case RUNE_PROTECT:this.castMindProtect(a,s);break;case RUNE_UNLOAD:this.castMindUltimate()}break;case RUNE_VOID:switch(t.runeName){case RUNE_STRIKE:this.castVoidStrike();break;case RUNE_REINFORCE:this.castVoidReinforce(e,t);break;case RUNE_ENHANCE:this.castVoidEnhance();break;case RUNE_PROTECT:this.castVoidProtect(a,s);break;case RUNE_UNLOAD:this.castVoidUltimate()}}}createDamageEffect(e,t,a,s=null,l={},n){let i,r=0,$=!1;if(null===s?((i=getTempPoolObject("spells","damageEffect3.png","damageEffect3",300)).setPosition(e,t).setAlpha(1),i.play("damageEffect"),i.setRotation((Math.random()-.5)*.35),$=!0):n?(i=this.scene.add.sprite(e,t,"spells").play(s),r=150):i=this.scene.add.sprite(e,t,"spells",s),i.setDepth(a),!$){let c=Object.assign({},{targets:i,scaleY:1.005,duration:150+r,ease:"Cubic.easeOut",onComplete(){i.destroy()}},l);this.scene.tweens.add(c)}return i}castMatterStrike(){let e=[],t=globalObjects.player.attackEnhanceMultiplier(),a=globalObjects.player.attackDamageAdder(),s=globalObjects.player.trueDamageAdder(),l=a>=6,n=getTempPoolObject("spells","rockCircle.png","rockCircle",800);n.setPosition(gameConsts.halfWidth,globalObjects.player.getY()-240);let i=.022*Math.sqrt(a),r=5*i,$=t*(12+a+s)>75;n.setDepth(100).setAlpha(0).setScale(.7+i).setRotation(3*Math.random()),this.scene.tweens.add({targets:n,duration:300,scaleX:0,scaleY:0}),this.scene.tweens.add({targets:n,duration:300,alpha:1,ease:"Cubic.easeOut"});let c=.6>Math.random(),o=.65+.0013*a,d=Math.floor(Math.sqrt(.75*a));for(let p=0;p<t;p++){let h=gameConsts.halfWidth+-((t-1)*25)+50*p,u=(t-1)*.5,m=globalObjects.player.getY()-240+10*Math.abs(u-p),g=poolManager.getItemFromPool("rock");g||((g=this.scene.add.image(h,m,"spells","rock.png")).bg=this.scene.add.image(h,m,"spells","rock_bg.png")),g.bg||(g.bg=this.scene.add.image(h,m,"spells","rock_bg.png")),g.bg.alpha=isMobile?.5:.35,g.bg.alpha+=Math.min(.24,.04*t),g.bg.visible=!0,g.setPosition(h,m).setDepth(40),g.bg.setPosition(h,m).setDepth(39),g.rotation=Math.random()-.5,e.push(g),g.setScale(0),g.bg.setScale(0);let _=(isMobile?.56:.5)+i+(l?-.05:0);this.scene.tweens.add({targets:[g,g.bg],delay:150,duration:400+Math.floor(1.5*a),scaleX:_,scaleY:_,ease:"Back.easeOut",onStart(){let e=d*(l?-10:-30)-75+150*Math.random();t>=2?(playSound("matter_strike_alt",.55*o).detune=e-150,setTimeout(()=>{playSound("matter_strike",o).detune=e+50},100)):playSound(c?"matter_strike":"matter_strike_alt",o).detune=e},onComplete:()=>{if(l){if(0==p){let e=playSound("matter_strike_heavy",o);a>=12&&zoomTempSlow(1.004),e.detune=-100*d}let t=getTempPoolObject("spells","rockglow.png","rockglow",400);t.setScale(g.scaleX).setPosition(g.x,g.y).setRotation(g.rotation).setAlpha(0).setDepth(g.depth+1),this.scene.tweens.add({targets:[g,t,g.bg],delay:110,duration:40,scaleX:.65+r,scaleY:.65+r,ease:"Back.easeOut",onStart:()=>{this.scene.tweens.add({targets:t,duration:40,alpha:Math.min(1,.45+.045*Math.sqrt(a)),ease:"Cubic.easeIn",onComplete:()=>{this.scene.tweens.add({targets:t,duration:500,alpha:0,ease:"Cubic.easeOut"})}})},onComplete:()=>{this.scene.tweens.add({targets:[g,t,g.bg],duration:150,scaleX:.5+r,scaleY:.5+r,ease:"Cubic.easeOut"})}}),n.setAlpha(.1).setScale(.8+r).setRotation(3*Math.random()),this.scene.tweens.add({targets:n,duration:250,scaleX:0,scaleY:0}),this.scene.tweens.add({targets:n,duration:250,alpha:1,ease:"Cubic.easeOut"})}}}),this.scene.tweens.add({targets:[g,g.bg],delay:150,duration:450+Math.floor(1.5*a),rotation:(Math.random()-.5)*3,ease:"Quart.easeOut"})}for(let b=0;b<e.length;b++){let f=e[b],y=600+b*(220-12*b)+2*a+(l?325:0),k=500+4*a,S=(isMobile?.37:.35)+.68*i;this.scene.tweens.add({targets:[f,f.bg],delay:y,x:gameConsts.halfWidth+(Math.random()-.5)*20,y:165+(Math.random()-.5)*15-Math.floor(2*Math.sqrt(a)),duration:k,scaleX:S,scaleY:S,rotation:(Math.random()-.5)*2,ease:"Quad.easeIn",onStart(){},onComplete:()=>{let t=-80*Math.floor(Math.sqrt(.65*a)),s=.005*a;if(0===b){let n=Math.random();n<.3?playSound("matter_strike_hit",.8+s).detune=t:n<.6?playSound("matter_strike_hit_alt",.8+s).detune=t:playSound("matter_strike_hit_alt_2",.85+s).detune=t}else e.length>2&&b===e.length-1?.5>Math.random()?playSound("matter_strike_hit",.7+s).detune=t:playSound("matter_strike_hit_alt",.7+s).detune=t:b%2==1?playSound("matter_strike_hit2",.95+s).detune=t:b%2==0&&(playSound("matter_strike_hit2",.6+s).detune=t);if(l){let i=getTempPoolObject("blurry","rock_rush.png","rockRush",300);if(i.setVisible(!0).setAlpha(.9+.003*a).setScale(.25+.0025*a).setRotation(6*Math.random()),i.setDepth(f.depth-1).setPosition(f.x,f.y),this.scene.tweens.add({targets:i,duration:250,alpha:0,scaleX:.5+.008*a,scaleY:.5+.008*a}),this.scene.tweens.add({targets:i,duration:250,y:"+=20",ease:"Cubic.easeIn"}),$&&b===e.length-1){let r=getTempPoolObject("tutorial","rune_matter_large.png","specialAttack",1300);r.setAlpha(.05).setDepth(999).setScale(5.2).setPosition(f.x,f.y),playSound("rock_crumble"),this.scene.tweens.add({targets:r,duration:110,alpha:1,onComplete(){zoomTemp(1.06),screenShake(6),messageBus.publish("tempPause",250,.05)}}),this.scene.tweens.add({targets:r,duration:125,y:"+=16",scaleX:3.3,scaleY:3.3,ease:"Quint.easeIn",onComplete:()=>{messageBus.publish("setSlowMult",.25,15),this.scene.tweens.add({delay:200,targets:r,duration:900,alpha:0,ease:"Cubic.easeOut"}),this.scene.tweens.add({delay:200,targets:r,duration:900,scaleX:3.8,scaleY:3.8,ease:"Cubic.easeIn"})}})}else $||(zoomTempSlow(1.003+1e-4*a),screenShake(.5+.001*a))}this.createDamageEffect(f.x,f.y,f.depth);let c=gameVars.matterPlus?14:12;messageBus.publish("enemyTakeDamage",c+a,!0,void 0,"matter"),messageBus.publish("setPauseDur",l?25:15),f.bg.visible=!1,poolManager.returnItemToPool(f,"rock")}})}let w=getBasicText("rune_matter_rune_strike");this.postAttackCast("matterStrike",0,w,a,t)}castMatterReinforce(){let e="matterReinforce",t,a,s=globalObjects.player.getStatuses()[e],l;s?(t=s.animObj[0],a=s.animObj[1],l=s.statusObj):(this.cleanseForms(),a=this.scene.add.image(gameConsts.halfWidth,globalObjects.player.getY(),"spells","brickPattern2.png"),t=this.scene.add.image(gameConsts.halfWidth,globalObjects.player.getY(),"spells","brickPattern1.png"));let n=globalObjects.player.spellMultiplier();t.rotation=-1-.75*n,t.setDepth(10),a.setDepth(10),t.setOrigin(.5,.5),a.setOrigin(.5,.5),t.alpha=.02,a.alpha=.02,t.setScale(.8),a.setScale(1.25+.1*Math.sqrt(n)),PhaserScene.time.delayedCall(400+50*n-175,()=>{playSound("matter_body")}),this.scene.tweens.add({targets:t,duration:400+50*n,scaleX:1.05+.015*n,scaleY:1.05+.015*n,alpha:.8,rotation:0,ease:"Cubic.easeIn",onComplete:()=>{t.alpha=1,this.scene.tweens.add({targets:t,delay:500,duration:1e3,alpha:.7,ease:"Quad.easeOut"});let e=.994+.006*Math.sqrt(n);t.origScale=e,this.scene.tweens.add({targets:t,scaleX:e,scaleY:e,duration:500,ease:"Cubic.easeOut"})}}),this.scene.tweens.add({targets:a,duration:300,scaleX:.8,scaleY:.8,alpha:1.1,ease:"Quart.easeIn",onComplete(){}});let i=1*n,r=1.15+.1*i;messageBus.publish("animateArmorNum",gameConsts.halfWidth,globalObjects.player.getY()-50,"+"+i+" THORNS",r,{duration:400,ease:"Quad.easeOut",y:"-=1",scaleX:r,scaleY:r},{alpha:0,duration:1600,scaleX:.95*r,scaleY:.95*r}),messageBus.publish("selfTakeEffect",{name:e,spellID:e,animObj:[t,a],protection:i,damage:1*n,spriteSrc1:"rune_reinforce_glow.png",spriteSrc2:"rune_matter_glow.png",displayAmt:i,statusObj:l,cleanUp:t=>{t[e]&&!t[e].currentAnim&&(t[e].currentAnim=this.scene.tweens.add({targets:t[e].animObj,duration:300,scaleX:.55,scaleY:.55,alpha:.6,ease:"Back.easeIn",onComplete(){for(;t[e]&&t[e].animObj.length>0;)t[e].animObj.pop().destroy(),0===t[e].animObj.length&&(t[e]=null)}}))}});let $=getBasicText("rune_matter_rune_reinforce");n>=3&&($=$+" x"+n),this.postNonAttackCast(e,$)}castMatterEnhance(){let e,t="matterEnhance",a=[],s=0,l,n=globalObjects.player.getStatuses()[t];n&&(l=n.statusObj,s=n.multiplier,a=n.animObj);let i=[];for(let r=0;r<globalObjects.player.spellMultiplier();r++){e=this.scene.add.sprite(gameConsts.halfWidth,globalObjects.player.getY(),"spells","matter_boost.png").setDepth(9);let $=s+r;e.rotation=.6+.18*$,e.setScale(-1,.75),i.push(e),a.push(e)}for(let c=0;c<i.length;c++)this.scene.tweens.add({targets:i[c],delay:i.length*Math.random()*5+20*c,duration:325+200*Math.random(),ease:"Back.easeOut",scaleY:.98+.1*Math.random(),onStart(){if(0===c){let e=playSound("matter_enhance",.9);.55>Math.random()?e.detune=-60:e.detune=60,e.detune+=Math.floor(120*Math.random())-60}else c===i.length-1&&(i.length<4?PhaserScene.time.delayedCall(50,()=>{let e=playSound("matter_enhance_2",1);.25>Math.random()?e.detune=-70:e.detune=0}):playSound("matter_enhance_2",1).detune=0)}});messageBus.publish("selfTakeEffect",{ignoreBuff:!0,name:t,spellID:t,animObj:a,multiplier:a.length,statusObj:l,cleanUp:e=>{if(e[t]&&!e[t].currentAnim){let a=e[t].animObj;for(let s=0;s<a.length;s++)this.scene.tweens.add({delay:60*s,targets:a[s],duration:300,scaleY:"+=0.14",ease:"Quart.easeOut",onStart(){setTimeout(()=>{a[s].setFrame("matter_boost_glow.png")},100)},onComplete:()=>{a[s].scaleX*=1.08,this.scene.tweens.add({targets:a[s],duration:300,scaleY:.6,ease:"Quart.easeIn",onComplete(){a[s].destroy()}})}})}}});let o=getBasicText("rune_matter_rune_enhance")+"\n+"+globalObjects.player.attackDamageAdder();this.postNonAttackCast(t,o)}castMatterProtect(e,t,a){this.cleanUpExistingShield(e);let s=globalObjects.player.spellMultiplier(),l=this.scene.add.sprite(gameConsts.halfWidth,MAGIC_CIRCLE_HEIGHT-225,"spells","impact.png");l.startX=l.x,l.startY=l.y,l.setDepth(1),l.setOrigin(.5,1),l.rotation=0,l.visible=!1,l.rotateOffset=0;let n=s>1.1?"stoneShieldTriple.png":"stoneShield.png";a&&(n="stoneShieldTriple.png");let i=this.scene.add.image(gameConsts.halfWidth,MAGIC_CIRCLE_HEIGHT,"spells",n);i.setDepth(1),i.setOrigin(.5,1),i.setScale(.75),i.origScaleX=.97+.025*s,i.rotation=0;let r=this.scene.add.bitmapText(gameConsts.halfWidth,MAGIC_CIRCLE_HEIGHT-222,"armor","0",32,1);r.startX=r.x,r.startY=r.y,r.setOrigin(.5,.5),r.setDepth(120),r.setScale(0);for(let $=0;$<s;$++){let c=this.scene.add.image(gameConsts.halfWidth,MAGIC_CIRCLE_HEIGHT-200,"spells","rockCircle.png");c.setDepth(120),c.setScale(.75+.3*$),c.setAlpha(0),c.rotation=6.28*Math.random(),this.scene.tweens.add({delay:150*$-150,targets:c,duration:250,scaleX:0,scaleY:0,y:"-=30",alpha:1,onStart(){0===$&&(playSound("matter_shield").detune=200-Math.floor(300*Math.random()))},onComplete(){c.destroy()}})}let o=(gameVars.matterPlus?14:12)*s;a&&(o=80),r.setText(o),messageBus.publish("setTempRotObjs",[i],t),this.scene.tweens.add({targets:r,delay:200,duration:400,scaleX:1,scaleY:1,ease:"Cubic.easeOut"}),i.currAnim&&i.currAnim.stop(),this.scene.tweens.add({targets:i,duration:240,scaleX:1.1,scaleY:1.1,ease:"Cubic.easeOut",onComplete:()=>{l.setDepth(117),i.setDepth(117),i.currAnim=this.scene.tweens.add({targets:i,duration:330,scaleX:1,scaleY:1,ease:"Quart.easeIn",onComplete(){i.currAnim=null}}),messageBus.publish("selfTakeEffect",{name:e,spellID:e,type:"matter",animObj:[i,r,l],spriteSrc1:"rune_protect_glow.png",spriteSrc2:"rune_matter_glow.png",shakeAmt:0,impactVisibleTime:0,multiplier:s,health:o,displayAmt:o,lockRotation:t,active:!0,ignoreBuff:!0,cleanUp:t=>{t[e]&&!t[e].currentAnim&&(l.setDepth(1),i.setDepth(1),t[e].currentAnim=this.scene.tweens.add({targets:i,duration:175,scaleX:"-=0.2",scaleY:"-=0.2",alpha:0,ease:"Quad.easeIn",onComplete(){i.destroy(),l.destroy(),r.destroy()}}),messageBus.publish("selfClearEffect",e,!0),t[e]=null)}})}});let d=getBasicText("rune_time_rune_protect"),p=0;s>=3&&(d=d+" X"+s,p=.1),a&&(d="SUPER STONE SHIELD",p=.1),this.postNonAttackCast("matterProtect",d,p)}castMatterUltimate(){this.castMatterStrike()}castTimeStrike(){let e=globalObjects.player.attackDamageAdder(),t=globalObjects.player.trueDamageAdder(),a=e>=6,s=e>=14,l=globalObjects.player.attackEnhanceMultiplier(),n=l*(6+(e+t)*1.5)>85,i=[],r=.5+.075*Math.sqrt(e)+.02*e,$=.4+.05*Math.sqrt(e)+.015*e;s||(playSound("time_strike_buff",a?.7:.9).detune=Math.floor(50*Math.random())+375);for(let c=0;c<l;c++){let o=gameConsts.halfWidth+-((l-1)*25)+50*c,d=(l-1)*.5,p=globalObjects.player.getY()-238+10*Math.abs(d-c),h=poolManager.getItemFromPool("clock");h||(h=this.scene.add.sprite(o,p,"spells","clock.png")),h.setDepth(10).setVisible(!0).setAlpha(1).setPosition(o,p).setFrame("clock.png"),h.rotation=Math.random()-.5,h.setScale(0),i.push(h),this.scene.tweens.add({targets:h,duration:150,scaleX:.5,scaleY:.5,rotation:"-=0.8",easeParams:[2],ease:"Back.easeOut",onComplete:()=>{if(!a)return;let t=1.1+.5*Math.random();0===c&&s&&(playSound("time_strike_buff",.7).detune=Math.floor(50*Math.random())-100),this.scene.tweens.add({delay:200,targets:h,duration:250,rotation:"+="+t,scaleX:.65,scaleY:.65,easeParams:[3],ease:"Back.easeOut",onStart(){0!==c||s||setTimeout(()=>{playSound("time_strike_buff",.9).detune=Math.floor(50*Math.random())-100},100)},onComplete:()=>{if(!s)return;0===c&&(zoomTempSlow(1.005),screenShake(.3+8e-4*e),playSound("time_strike_buff",1).detune=-Math.floor(50*Math.random())-375);let a=1.8*t;this.scene.tweens.add({delay:200,targets:h,duration:250,rotation:"-="+a,scaleX:r,scaleY:r,easeParams:[3],ease:"Back.easeOut",onComplete(){0===c&&(playSound("time_strike_buff",1.2).detune=-Math.floor(50*Math.random())-775)}})}})}})}let u=6+e,m=Math.ceil(.5*u),g=0;for(let _ in a&&(g+=470,s&&(g+=470)),i){let b=i[_];b.finalRot=.2-.4*Math.random();let f=this.scene.add.sprite(b.x,b.y,"spells","clock_red.png").setDepth(10).setRotation(b.rotation).setScale(r).setAlpha(.75);f.finalRot=b.finalRot,f.visible=!1;let y=270+150*_+g,k=(Math.random()-.5)*200,S=(k<0?4:-4)+(Math.random()-.5)*2-.02*k;this.scene.tweens.add({delay:y,targets:[b,f],duration:550,rotation:S,onStart(){playSound("time_strike").detune=Math.floor(250*Math.random())-125}});let w=gameConsts.halfWidth+k,O=gameConsts.halfWidth+Math.random()-2.5,C=120+Math.random()-2.5;this.scene.tweens.add({delay:y,targets:b,y:C,duration:550,scaleX:$,scaleY:$,ease:"Back.easeOut",easeParams:[.25],onStart:()=>{f.visible=!0,f.rotation=b.rotation,this.scene.tweens.add({targets:b,x:w,duration:200,ease:"Quad.easeOut",onComplete:()=>{this.scene.tweens.add({targets:b,x:.8*gameConsts.halfWidth+.2*w,duration:200,ease:"Quad.easeIn",onComplete:()=>{this.scene.tweens.add({targets:b,x:O,duration:150,easeParams:[.5],ease:"Back.easeOut"})}})}})},onComplete:()=>{b.setFrame("clockStrike.png"),b.rotation=b.finalRot,this.scene.tweens.add({targets:b,duration:200+2*e,scaleX:$+.24,scaleY:$+.24,alpha:0,onComplete(){poolManager.returnItemToPool(b,"clock")}});let t=parseInt(_);if(0===t?playSound("time_strike_hit",.92).detune=Math.floor(100*Math.random())-50:i.length>2&&t===i.length-1?playSound("time_strike_hit",.85):t%2==1?playSound("time_strike_hit_2",1):t%2==0&&playSound("time_strike_hit_2",.75),messageBus.publish("enemyTakeDamage",u,!0,void 0,"time"),messageBus.publish("setPauseDur",20),n&&parseInt(_)===i.length-1){let a=getTempPoolObject("tutorial","rune_time_large.png","specialAttack",1300);a.setAlpha(.05).setDepth(999).setScale(5).setPosition(gameConsts.halfWidth,b.y+33),playSound("time_hard"),this.scene.tweens.add({targets:a,duration:110,alpha:1,onComplete(){zoomTemp(1.06),screenShake(6),messageBus.publish("tempPause",250,.05)}}),this.scene.tweens.add({targets:a,duration:125,scaleX:3.15,scaleY:3.15,ease:"Quint.easeIn",onComplete:()=>{messageBus.publish("setSlowMult",.25,15),this.scene.tweens.add({delay:200,targets:a,duration:900,alpha:0,ease:"Cubic.easeOut"}),this.scene.tweens.add({delay:200,targets:a,duration:900,scaleX:3.8,scaleY:3.8,ease:"Cubic.easeIn"})}})}else n||(zoomTempSlow(1.002+1e-4*e),screenShake(.35+.001*e))}}),this.scene.tweens.add({delay:y+175,targets:f,y:C,duration:550,scaleX:$,scaleY:$,ease:"Back.easeOut",easeParams:[.9],onStart:()=>{this.scene.tweens.add({targets:f,x:w,duration:200,ease:"Quad.easeOut",onComplete:()=>{this.scene.tweens.add({targets:f,x:.8*gameConsts.halfWidth+.2*w,duration:200,ease:"Quad.easeIn",onComplete:()=>{this.scene.tweens.add({targets:f,x:O,duration:150,easeParams:[.5],ease:"Back.easeOut"})}})}})},onComplete:()=>{f.setFrame("clock_redStrike.png"),f.rotation=f.finalRot,this.scene.tweens.add({targets:f,duration:250+2*e,scaleX:$+.4,scaleY:$+.4,ease:"Quad.easeOut",onComplete(){f.destroy()}}),this.scene.tweens.add({targets:f,duration:250+2*e,alpha:0});let t=getTempPoolObject("spells","blackPulse.png","blackPulse",200).setDepth(f.depth-1).setScale(.3).setAlpha(.8).setPosition(f.x,f.y),a=.9*$+.75+.5*Math.random();this.scene.tweens.add({targets:t,duration:300,scaleX:a,scaleY:a,alpha:0}),messageBus.publish("enemyTakeDamage",m,!0,void 0,"time"),messageBus.publish("setPauseDur",15)}})}let A=getBasicText("rune_time_rune_strike");this.postAttackCast("timeStrike",300,A,e,l)}castTimeReinforce(){let e=globalObjects.player.spellMultiplier(),t=1-.5**e,a=this.scene.add.image(gameConsts.halfWidth,globalObjects.player.getY(),"spells","clock_back_large.png");this.cleanseForms(),playSound("time_body"),a.setDepth(120).setScale(1.05),a.alpha=0;let s=this.scene.add.image(gameConsts.halfWidth,globalObjects.player.getY(),"spells","clock_arm_large.png");s.setDepth(120).setScale(1.2),s.setOrigin(.01,.5),s.alpha=0,s.rotation=-(.5*Math.PI),this.scene.tweens.add({targets:[a],duration:300,alpha:.4+.1*e,scaleX:.97,scaleY:.97,ease:"Cubic.easeOut",onComplete(){messageBus.publish("selfHealRecent",t)}}),this.scene.tweens.add({targets:[s],duration:400,alpha:.55+.12*e,scaleX:.94,scaleY:.94,ease:"Cubic.easeOut"}),this.scene.tweens.add({targets:[s],duration:1200,rotation:-(.5*Math.PI)-2*Math.PI*t,ease:"Cubic.easeInOut"}),this.scene.tweens.add({targets:[a],duration:1200,rotation:.05,ease:"Cubic.easeInOut"}),this.scene.tweens.add({targets:[a,s],delay:900,duration:500,scaleX:1.12,scaleY:1.12,alpha:0});let l=getBasicText("rune_time_rune_reinforce");e>1&&(l+=" X"+e),this.postNonAttackCast("timeReinforce",l)}castTimeEnhance(){let e="timeEnhance",t=globalObjects.player.getStatuses()[e],a=[];t&&(a=t.animObj);let s=globalObjects.player.spellMultiplier(),l=Math.round(.5*a.length),n=s,i=l+s;if(a.length>0)for(let r=0;r<a.length;r+=2){let $=gameConsts.halfWidth+-((i-1)*25)+25*r,c=(i-1)*.5,o=globalObjects.player.getY()-240+10*Math.abs(c-.5*r);this.scene.tweens.add({targets:[a[r],a[r+1]],duration:300,x:$,y:o,ease:"Cubic.easeOut"})}else i=l+ ++s;for(let d=l;d<i;d++){let p=gameConsts.halfWidth+-((i-1)*25)+50*d,h=(i-1)*.5,u=globalObjects.player.getY()-240+10*Math.abs(h-d),m=this.scene.add.image(p,u,"spells","timeEffect.png"),g=this.scene.add.image(p,u,"spells","timeEffect2.png");m.setDepth(11),m.rotation=Math.random()-.5,m.setScale(0),g.setDepth(10),g.rotation=(Math.random()-.5)*10,g.setScale(0),a.push(m),a.push(g),this.scene.tweens.add({targets:[m,g],duration:300,scaleX:1,scaleY:1,ease:"Cubic.easeOut"}),this.scene.tweens.add({targets:m,duration:5200,rotation:"+=6.283",repeat:-1}),this.scene.tweens.add({targets:g,duration:5200,rotation:"-=3.14",repeat:-1})}playSound("time_enhance"),this.scene.tweens.add({targets:a[0],duration:300,alpha:.99,onComplete:()=>{messageBus.publish("selfTakeEffect",{name:e,spellID:e,animObj:a,multiplier:Math.round(.5*a.length),ignoreBuff:!0,cleanUp:t=>{t[e]&&!t[e].currentAnim&&(t[e].currentAnim=this.scene.tweens.add({targets:a,delay:25,duration:200,scaleX:0,scaleY:0,ease:"Quad.easeOut",onStart(){t[e]=null},onComplete(){for(let e=0;e<a.length;e++)a[e].destroy()}}))}})}});let _=getBasicText("rune_time_rune_enhance")+" +"+n;this.postNonAttackCast(e,_)}castTimeProtect(e,t){let a="timeProtect";this.cleanUpExistingShield(e);let s,l=globalObjects.player.getStatuses()[a];l&&(s=l.statusObj);let n=globalObjects.player.spellMultiplier(),i="clockShield.png";n>=2&&(i="clockShieldTriple.png");let r=this.scene.add.image(gameConsts.halfWidth,MAGIC_CIRCLE_HEIGHT,"spells",i);r.setDepth(118),r.setOrigin(.5,1),r.setScale(.75),r.origScaleX=.95,r.rotation=t;let $="blank.png";n>=2&&($="clockShieldTripleSatellite.png");let c=this.scene.add.image(gameConsts.halfWidth,MAGIC_CIRCLE_HEIGHT,"spells",$);c.setDepth(118),c.setOrigin(.5,1),c.setScale(.75),c.origScaleX=.95,c.rotation=t,playSound("time_shield"),messageBus.publish("setTempRotObjs",[r,c],t),this.scene.tweens.add({targets:[r,c],duration:400,ease:"Cubic.easeOut",scaleX:.95,scaleY:.965,onStart:()=>{messageBus.publish("selfTakeEffect",{ignoreBuff:!0,name:e,spellID:e,type:"time",animObj:[r,c],lockRotation:t,spriteSrc1:"rune_protect_glow.png",spriteSrc2:"rune_time_glow.png",displayAmt:0,active:!0,maxAmt:60*n,multiplier:n,statusObj:s,cleanUp:t=>{t[e]&&!t[e].currentAnim&&(t[e].currentAnim=this.scene.tweens.add({targets:[r,c],duration:250,scaleX:.55,scaleY:.55,alpha:0,ease:"Quad.easeOut",onComplete(){r.destroy(),c.destroy()}}),messageBus.publish("selfClearEffect",e,!0),t[e]=null)}})}});let o=getBasicText("rune_time_rune_protect");n>1.1&&(o=o+" X"+n),this.postNonAttackCast(a,o,0)}castTimeUltimate(){this.castTimeStrike()}castMindStrike(){let e="mindStrike",t=[],a=globalObjects.player.attackEnhanceMultiplier(),s=globalObjects.player.attackDamageAdder(),l=a*(1+(s+globalObjects.player.trueDamageAdder())*2)>70;for(let n=0;n<a;n++){let i=gameConsts.halfWidth+-((a-1)*25)+50*n,r=(a-1)*.5,$=globalObjects.player.getY()-225+10*Math.abs(r-n)+s,c=this.scene.add.sprite(i,$,"spells","lightningBolt1.png");c.play("lightningbolt"),c.setDepth(10),c.rotation=Math.random()-.5,t.push(c),c.setScale(0),c.setOrigin(.5,.1)}for(let o=0;o<t.length;o++){let d=t[o],p=50+o*(190-6*t.length);this.scene.tweens.add({targets:d,delay:p,duration:200,scaleX:.7+.006*s,scaleY:.8+.007*s,rotation:-Math.atan2(200,gameConsts.halfWidth-d.x)+1.57,ease:"Cubic.easeOut"}),this.scene.tweens.add({targets:d,delay:p,x:gameConsts.halfWidth,y:200,ease:"Quad.easeIn",duration:400+3*s,onStart(){playSound("mind_strike")},onComplete:()=>{let a=getTempPoolObject("spells","blackPulse.png","blackPulse",310).setDepth(d.depth).setScale(.5).setAlpha(.6).setPosition(d.x,d.y-12),n=getTempPoolObject("spells","shockEffect1.png","shockEffect",310).play("shockEffect").setPosition(d.x,d.y-12).setDepth(d.depth).setScale(.5).setRotation(6*Math.random()),i=1.3+.1*Math.random();if(playSound("mind_strike_hit"),this.scene.tweens.add({targets:[a],alpha:0,duration:480}),this.scene.tweens.add({targets:[n,a],scaleX:i,scaleY:i,duration:460,ease:"Quart.easeOut"}),messageBus.publish("enemyTakeTrueDamage",1+s,!0,void 0,!0,"mind"),l&&o===t.length-1){let r=getTempPoolObject("tutorial","rune_energy_large.png","specialAttack",1300);r.setAlpha(.05).setDepth(999).setScale(3.9,2.5).setPosition(d.x,d.y-80),playSound("thunder"),this.scene.tweens.add({targets:r,duration:110,alpha:1,onComplete(){zoomTemp(1.06),screenShake(6),messageBus.publish("tempPause",250,.05)}}),this.scene.tweens.add({targets:r,duration:300,y:"+=76",ease:"Back.easeOut"}),this.scene.tweens.add({targets:r,duration:125,scaleX:3.5,scaleY:4.2,ease:"Quint.easeIn",onComplete:()=>{messageBus.publish("setSlowMult",.25,15),this.scene.tweens.add({targets:r,duration:100,scaleY:3.5,ease:"Cubic.easeOut"}),this.scene.tweens.add({delay:200,targets:r,duration:900,alpha:0,ease:"Cubic.easeOut"}),this.scene.tweens.add({delay:200,targets:r,duration:900,scaleX:4,scaleY:4,ease:"Cubic.easeIn"})}})}else s>=12&&screenShake(.25+.0025*s);if(globalObjects.currentEnemy&&!globalObjects.currentEnemy.dead&&!globalObjects.currentEnemy.invincible&&!globalObjects.player.dead){let $=this.scene.add.sprite(d.x,d.y-14,"spells","energyTarget7.png").play("energyTarget").setAlpha(1).setScale(.96);$.setDepth(30),$.setOrigin(.5,.5),this.scene.tweens.add({targets:[$],duration:500,alpha:.58,scaleX:.9,scaleY:.9,ease:"Quad.easeOut"}),messageBus.publish("animateTrueDamageNum",d.x+12-24*Math.random(),d.y-28-5*Math.random(),"VULNERABLE",isMobile?.9:.85),messageBus.publish("enemyTakeEffect",{name:e,x:$.x,y:$.y,cleanUp:(t,a,s)=>{if(t[e]&&!t[e].currentAnim){if(!globalObjects.currentEnemy.isDestroyed){let l=getTempPoolObject("lowq","circle_blue4.png","circle_blue",1800).setDepth(100).setScale(.65).setAlpha(.85+.025*Math.sqrt(a)).setPosition(d.x,d.y-14);l.playReverse("circleBlast");let n=.67+.12*Math.sqrt(a);this.scene.tweens.add({targets:l,duration:500+10*a,scaleX:n,scaleY:n,ease:"Cubic.easeOut"}),this.scene.tweens.add({targets:l,duration:500+10*a,alpha:0}),s&&($.setScale(1.2),$.stop(),$.alpha=1,$.play("energyTargetExplode"))}let i=s?100:0;this.scene.tweens.add({targets:[$],duration:200+i,scaleX:s?1.1:1.15,scaleY:s?1.1:1.15,ease:"Cubic.easeOut"}),t[e].currentAnim=this.scene.tweens.add({targets:[$],duration:200+i,alpha:0,ease:s?"Quad.easeIn":"",onComplete(){$.destroy()}}),t[e]=null}}})}this.scene.tweens.add({targets:d,alpha:0,scaleX:"-=0.2",scaleY:"-=0.1",duration:120,onComplete(){d.destroy()}})}})}let h=getBasicText("rune_mind_rune_strike");this.postAttackCast(e,0,h,s,a)}castMindReinforce(){let e="mindReinforce",t=globalObjects.player.spellMultiplier(),a=globalObjects.player.getStatuses()[e],s,l,n,i;a?(i=a.animObj[0],l=a.animObj[1],n=a.animObj[2],s=a.statusObj):(this.cleanseForms(),l=this.scene.add.image(gameConsts.halfWidth,globalObjects.player.getY(),"circle","energy_body.png").setScale(.9).setAlpha(.75).setDepth(104),n=this.scene.add.image(gameConsts.halfWidth,globalObjects.player.getY(),"circle","energy_body.png").setScale(.8).setAlpha(.25).setRotation(Math.PI/8).setDepth(104),i=this.scene.add.sprite(gameConsts.halfWidth,globalObjects.player.getY(),"spells").play("powerEffectRepeat").setScale(1.5).setDepth(117));let r=this.scene.add.sprite(gameConsts.halfWidth,globalObjects.player.getY(),"spells").play("powerEffect").setScale(3.4).setDepth(117);playSound("power_surge"),this.scene.tweens.add({targets:l,duration:125,scaleX:1.11+.02*t,scaleY:1.11+.02*t,alpha:1,ease:"Cubic.easeOut",onComplete:()=>{playSound("mind_shield_retaliate",.7+.05*t),this.scene.tweens.add({targets:l,duration:400,scaleX:.975+.01*t,scaleY:.975+.01*t,ease:"Back.easeOut",onComplete:()=>{this.scene.tweens.add({targets:l,duration:750,alpha:.6})}})}}),this.scene.tweens.add({targets:n,duration:225,scaleX:1.13+.02*t,scaleY:1.13+.02*t,alpha:1,ease:"Cubic.easeOut",onComplete:()=>{this.scene.tweens.add({targets:n,duration:450,scaleX:1+.012*t,scaleY:1+.012*t,ease:"Back.easeOut",onComplete:()=>{this.scene.tweens.add({targets:n,duration:750,alpha:.6})}})}}),this.scene.tweens.add({targets:i,duration:400,scaleX:1.9,scaleY:1.9,alpha:.8,ease:"Cubic.easeOut",completeDelay:250,onComplete(){i.setScale(1.57)}}),this.scene.tweens.add({targets:r,duration:500,scaleX:3.55,scaleY:3.55,ease:"Cubic.easeOut",onComplete(){r.destroy()}});let $=3;t>1&&($=3*t),messageBus.publish("animateTrueDamageNum",gameConsts.halfWidth,globalObjects.player.getY()-50,"+"+$+" ALL\nDAMAGE",.9+.15*Math.sqrt($),{duration:1650},{alpha:0,scaleX:1,scaleY:1}),messageBus.publish("selfTakeEffect",{name:e,spellID:e,animObj:[i,l,n],multiplier:t,spriteSrc1:"rune_reinforce_glow.png",spriteSrc2:"rune_mind_glow.png",displayAmt:$,statusObj:s,cleanUp:t=>{t[e]&&!t[e].currentAnim&&(t[e].currentAnim=this.scene.tweens.add({targets:t[e].animObj,duration:300,scaleX:1,scaleY:1,alpha:0,ease:"Back.easeIn",onComplete(){for(;t[e]&&t[e].animObj.length>0;)t[e].animObj.pop().destroy(),0==t[e].animObj.length&&(t[e]=null)}}))}});let c=getBasicText("rune_mind_rune_reinforce");t>=2&&(c+=" X"+t),this.postNonAttackCast(e,c)}castMindEnhance(){let e="mindEnhance",t=globalObjects.player.getStatuses()[e],a=globalObjects.player.spellMultiplier(),s;if(t){let l=.25+.1*(a+=t.multiplier);s=t.animObj,this.scene.tweens.add({targets:s,duration:300,ease:"back.easeOut",scaleX:l,scaleY:l})}else s=this.scene.add.sprite(gameConsts.halfWidth+205,gameConsts.height-295,"spells").play("mindBurnSlow").setDepth(11).setScale(0);playSound("mind_enhance");let n=.25+.1*a;this.scene.tweens.add({targets:s,duration:250,ease:"back.easeOut",scaleX:n,scaleY:n}),messageBus.publish("selfTakeEffect",{ignoreBuff:!0,name:e,spellID:e,animObj:s,multiplier:a,cleanUp:t=>{t[e]&&!t[e].currentAnim&&(s.setScale(1.1*s.scaleX),t[e].currentAnim=this.scene.tweens.add({targets:s,duration:150,scaleX:1.7*s.scaleX,scaleY:1.7*s.scaleX,alpha:0,ease:"Quad.easeOut",onComplete(){s.destroy()}}),t[e]=null)}});let i=getBasicText("rune_mind_rune_enhance");a>1&&(i+=" X"+a),this.postNonAttackCast(e,i)}castMindProtect(e,t){this.cleanUpExistingShield(e);let a=globalObjects.player.spellMultiplier(),s="eyeShield.png";a>3.1?s="eyeShieldQuint.png":a>1.1&&(s="eyeShieldTriple.png");let l=this.scene.add.image(gameConsts.halfWidth,MAGIC_CIRCLE_HEIGHT,"spells",s);l.setDepth(110),l.setOrigin(.5,1),l.setScale(.85),l.origScaleX=.95+.05*a,l.rotation=0,l.alpha=0;let n=this.scene.add.sprite(gameConsts.halfWidth,175,"spells","reticle.png").setScale(.95);n.setDepth(110),n.origScale=n.scaleX,n.alpha=.3,n.visible=!1;let i=this.scene.add.image(gameConsts.halfWidth,globalObjects.player.getY()-225,"spells","weakenLines_00.png");i.startX=i.x,i.startY=i.y,i.setDepth(9999),i.setOrigin(.5,1),i.rotation=0,i.alpha=0,i.rotateOffset=0;let r=this.scene.add.bitmapText(gameConsts.halfWidth,n.y,"bonus","",48,1);r.setOrigin(.5,.5),r.setDepth(n.depth),r.setScale(.5),messageBus.publish("setTempRotObjs",[l],t),playSound("mind_shield"),this.scene.tweens.add({targets:l,duration:350,scaleX:1,scaleY:1,alpha:.5,ease:"Cubic.easeIn",onComplete:()=>{messageBus.publish("selfTakeEffect",{ignoreBuff:!0,name:e,spellID:e,type:"mind",animObj:[l,n,i],textObj:r,storedDamage:0,multiplier:a,spriteSrc1:"rune_protect_glow.png",spriteSrc2:"rune_mind_glow.png",lockRotation:t,cleanUp:t=>{t[e]&&!t[e].currentAnim&&(r.visible=!1,t[e].currentAnim=this.scene.tweens.add({delay:100,targets:[l,n],duration:150,alpha:0,ease:"Quad.easeIn",onComplete(){l.destroy(),n.destroy(),i.destroy(),r.destroy()}}),t[e].eyeBlastAnim&&t[e].eyeBlastAnim.stop(),messageBus.publish("selfClearEffect",e,!0),t[e]=null)}})}});let $=getBasicText("rune_mind_rune_protect"),c=0;a>=2&&($=$+" X"+a,c=.15),this.postNonAttackCast("mindProtect",$,c)}castMindUltimate(){let e="mindUnload",t=globalObjects.player.getStatuses()[e],a=1,s=[];t&&(a=t.multiplier,s=t.animObj);let l,n=3;a>1?(playSound("mind_ultimate_2",.95),n=a+2,l=this.scene.add.image(gameConsts.halfWidth,globalObjects.player.getY(),"spells","mind_boost_2.png").setDepth(40),PhaserScene.tweens.add({targets:PhaserScene.cameras.main,zoom:.95,ease:"Cubic.easeOut",duration:850,onComplete(){PhaserScene.tweens.add({targets:PhaserScene.cameras.main,zoom:1,ease:"Quart.easeIn",duration:450})}})):(playSound("mind_ultimate_1",.7),l=this.scene.add.image(gameConsts.halfWidth,globalObjects.player.getY(),"spells","mind_boost.png").setDepth(40),PhaserScene.tweens.add({targets:PhaserScene.cameras.main,zoom:.988,ease:"Cubic.easeOut",duration:550,onComplete(){PhaserScene.tweens.add({targets:PhaserScene.cameras.main,zoom:1,ease:"Cubic.easeIn",duration:200})}})),l.setDepth(0),l.setScale(.95),l.setAlpha(.25),s.push(l),globalObjects.magicCircle.setAuraAlpha(.4+.05*n),this.scene.tweens.add({targets:l,duration:500,alpha:.75,ease:"Cubic.easeOut",scaleX:1.25,scaleY:1.25,onStart:()=>{t&&t.soundObj&&t.soundObj.stop();let l=null,i=playSound("mind_ultimate_loop_1",.4,!0);a>1.01&&(l=playSound("mind_ultimate_loop_2",.8,!0)),messageBus.publish("selfTakeEffect",{ignoreBuff:!0,name:e,spellID:e,animObj:s,soundObj:i,soundObj2:l,multiplier:n,cleanUp:t=>{if(t[e]&&!t[e].currentAnim){playSound("mind_ultimate_cast");let a=t[e].soundObj,l=null;t[e].soundObj2&&(l=t[e].soundObj2),t[e].currentAnim=this.scene.tweens.add({targets:s,duration:180,alpha:0,ease:"Quad.easeOut",onComplete(){fadeAwaySound(a),l&&fadeAwaySound(l),t[e]=null;for(let n=0;n<s.length;n++)s[n].destroy()}})}}})}}),this.scene.tweens.add({targets:l,duration:7e4,rotation:"+=6.28318",repeat:-1});let i=n-1,r=getBasicText("rune_mind_rune_unload")+" +"+i+"00%",$=.15;n>4?$=.25:n>2&&($=.2),messageBus.publish("messageAllSpell",e),messageBus.publish("recordSpell",e,r,$)}castVoidStrike(){this.castMatterStrike()}castVoidReinforce(e,t){this.castMatterReinforce(e,t)}castVoidEnhance(){this.castMatterEnhance()}castVoidProtect(e,t){this.castMatterProtect(e,t)}castVoidUltimate(){this.castMindStrike()}createRockParticle(e,t,a,s,l){let n=this.particlesRock.pop();n||(n=this.scene.add.image(e,t,"spells","rock_chip.png")).setDepth(15),n.setScale(1.25),n.visible=!0,n.rotation=3.14*Math.random();let i=s*l;this.scene.tweens.add({targets:n,x:"+="+a*l,y:"+="+i,duration:l,rotation:(Math.random()-.5)*10}),this.scene.tweens.add({targets:n,y:"+="+i,duration:l,easeParams:[4],ease:"Back.easeOut"}),this.scene.tweens.add({targets:n,ease:"Cubic.easeIn",scaleX:0,scaleY:0,duration:l-150,completeDelay:150,onComplete:()=>{this.recycleRockParticle(n)}})}recycleRockParticle(e){e.visible=!1,this.particlesRock.push(e)}postAttackCast(e,t=0,a="UNNAMED ATTACK",s,l){PhaserScene.time.delayedCall(t,()=>{messageBus.publish("attackLaunched",e);let t=globalObjects.player.getStatuses().mindEnhance;if(t){let a=t.animObj;this.scene.tweens.add({targets:a,y:140,duration:400,onComplete(){messageBus.publish("applyMindBurn",5,t.multiplier),t.cleanUp(globalObjects.player.getStatuses())}}),this.scene.tweens.add({targets:a,ease:"Cubic.easeIn",x:gameConsts.halfWidth-10,duration:400})}}),messageBus.publish("recordSpellAttack",e,a,void 0,s,l),messageBus.publish("messageAllSpell",e,a),messageBus.publish("clearAttackMultiplier"),messageBus.publish("clearDamageAdder")}postNonAttackCast(e,t="UNNAMED SPELL"){messageBus.publish("recordSpell",e,t),messageBus.publish("messageAllSpell",e,t),messageBus.publish("clearSpellMultiplier")}cleanUpExistingShield(e){globalObjects.player.getStatuses()[e]&&messageBus.publish("selfClearEffect",e)}cleanseForms(){let e=globalObjects.player.getStatuses().mindReinforce,t=globalObjects.player.getStatuses().matterReinforce;e&&(messageBus.publish("selfClearStatuses","mindReinforce"),messageBus.publish("animateBlockNum",gameConsts.halfWidth,globalObjects.player.getY()+24,"-DAMAGE",.75,{duration:800,ease:"Cubic.easeOut",alpha:.9,y:"+=4"},{duration:1e3,ease:"Quad.easeIn",alpha:0})),t&&(messageBus.publish("selfClearStatuses","matterReinforce"),messageBus.publish("animateBlockNum",gameConsts.halfWidth,globalObjects.player.getY()+30,"-THORNS",.75,{duration:800,ease:"Cubic.easeOut",alpha:.9,y:"+=4"},{duration:1e3,ease:"Quad.easeIn",alpha:0}))}}

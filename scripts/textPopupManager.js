class TextPopupManager{constructor(t){this.scene=t,this.damageNums=[],this.damageNum=this.scene.add.bitmapText(gameConsts.halfWidth,170,"damage","",isMobile?34:32).setDepth(9991).setOrigin(.5,.65),this.damageNum.startY=this.damageNum.y,this.damageTween=null,this.damageNumber=0,this.bonusNums=[],this.healNums=[],this.blockNums=[],this.armorNums=[],this.voidNums=[],this.infoBlur=this.scene.add.image(0,0,"blurry","display_backglow.png").setAlpha(0).setDepth(9990),this.infoBox=this.scene.add.image(0,0,"blackPixel").setAlpha(0).setDepth(9990),this.infoText=this.scene.add.text(0,0,"WELCOME",{fontFamily:"Arial",fontSize:isMobile?23:22,color:"#FFFFFF",align:"center"}).setAlpha(0).setOrigin(.5,.5).setDepth(9990),this.infoText.setFontStyle("bold"),this.infoBorderTop=this.scene.add.image(0,0,"blurry","box_length.png").setAlpha(0).setDepth(9990),this.infoBorderBot=this.scene.add.image(0,0,"blurry","box_length.png").setAlpha(0).setDepth(9990),this.infoWhiteFlashLeft=this.scene.add.image(0,0,"pixels","white_pixel.png").setDepth(9990).setOrigin(0,.5).setScale(0).setAlpha(.7),messageBus.subscribe("animateDamageNum",this.animateDamageNum.bind(this)),messageBus.subscribe("animateDamageNumAccumulate",this.animateDamageNumAccumulate.bind(this)),messageBus.subscribe("animateTrueDamageNum",this.animateTrueDamageNum.bind(this)),messageBus.subscribe("animateHealNum",this.animateHealNum.bind(this)),messageBus.subscribe("animateBlockNum",this.animateBlockNum.bind(this)),messageBus.subscribe("animateArmorNum",this.animateArmorNum.bind(this)),messageBus.subscribe("animateVoidNum",this.animateVoidNum.bind(this))}getBoxTopPos(){return this.infoBox.y-this.infoBox.scaleY}getBoxCenterPos(){return this.infoBox.y}getBoxBottomPos(){return this.infoBox.y+this.infoBox.scaleY}getCenterPos(){return this.infoBox.x-this.infoBox.scaleX*(this.infoBox.originX-.5)*2}getDepth(){return this.infoBox.depth}setInfoText(t,e,i,s="center",a){this.infoText.x=t,this.infoText.y=e,this.infoText.setAlpha(0),this.infoBox.setAlpha(0),this.infoBlur.setAlpha(0),this.infoBorderTop.setAlpha(0),this.infoBorderBot.setAlpha(0),this.infoText.setAlign("left"),this.infoBox.x=t,this.infoBox.y=e+2,this.infoBlur.y=this.infoBox.y,"left"==s?(this.infoText.x+=3,this.infoText.setOrigin(0,.5),this.infoBox.setOrigin(0,.5)):"center"==s?(this.infoText.setAlign("center"),this.infoText.setOrigin(.5,.5),this.infoBox.setOrigin(.5,.5),this.infoBlur.x=this.infoBox.x):"right"==s&&(this.infoText.setOrigin(1,.5),this.infoText.x-=6,this.infoBox.setOrigin(1,.5)),this.infoBorderTop.setAlpha(0),this.infoBorderBot.setAlpha(0),this.infoText.setText(i);let h=a?.9:1;this.infoText.setScale(h);let o=.5*this.infoText.width+8,n=.5*this.infoText.height+10;n>50&&(this.infoText.y+=1),this.infoBox.setScale(o*h,n*h),this.infoWhiteFlashLeft.setScale(1,this.infoBox.scaleY),this.infoWhiteFlashLeft.x=this.infoBox.x-2*this.infoBox.scaleX*this.infoBox.originX,this.infoWhiteFlashLeft.y=this.infoBox.y,this.infoBlur.setScale(.021*this.infoBox.scaleX,.025*this.infoBox.scaleY),this.infoBlur.x=this.getCenterPos();let r=o*h*.02;this.infoBorderTop.setScale(.1*r,.5).setPosition(this.getCenterPos(),this.infoBox.y-(n+-2)*h),this.infoBorderBot.setScale(.1*r,-.5).setPosition(this.getCenterPos(),this.infoBox.y+(n-2)*h),this.currAnim=this.scene.tweens.add({targets:[this.infoText,this.infoBorderTop,this.infoBorderBot],alpha:1,duration:300}),this.currAnim3=this.scene.tweens.add({targets:[this.infoBorderTop,this.infoBorderBot],scaleX:r,ease:"Quart.easeInOut",duration:1e3,onComplete:()=>{this.currAnim=this.scene.tweens.add({targets:[this.infoBorderTop,this.infoBorderBot],alpha:.78,duration:1e3})}}),this.currAnim2=this.scene.tweens.add({targets:[this.infoBox,this.infoBlur],alpha:.7,duration:300}),this.currAnim4=this.scene.tweens.add({delay:50,targets:[this.infoWhiteFlashLeft],scaleX:this.infoBox.scaleX,ease:"Quint.easeIn",duration:550,alpha:1,onComplete:()=>{let t=this.infoBox.x+this.infoBox.scaleX;"left"==s?t+=this.infoBox.scaleX:"right"==s&&(t-=this.infoBox.scaleX),this.currAnim4=this.scene.tweens.add({targets:[this.infoWhiteFlashLeft],x:t,scaleX:0,ease:"Quint.easeOut",duration:550,alpha:.7})}})}getWidth(){return 2*this.infoBox.scaleX}hideInfoText(){this.currAnim&&(this.currAnim.stop(),this.currAnim2.stop(),this.currAnim3.stop()),this.scene.tweens.add({targets:[this.infoText,this.infoBox,this.infoBorderTop,this.infoBorderBot,this.infoBlur],alpha:0,duration:300})}animateDamageNum(t,e,i,s,a){let h=this.getTextObjFromArray(t,e,i,this.damageNums,"damage"),o=isMobile?1.15:1;h.setScale(s*o).setAlpha(1),this.animateNum(h,this.damageNums,a)}animateDamageNumAccumulate(t,e=0){this.damageTween&&this.damageTween.stop(),this.damageNum.scaleX<.1&&(this.damageNumber=0);let i=0;this.damageNumber+=t,i=0===this.damageNumber?.05:this.damageNumber<15?.5:this.damageNumber<40?.8:this.damageNumber<100?1:this.damageNumber<160?1.15:1.2,this.damageNum.setText("-"+this.damageNumber);let s=.8+.15*Math.sqrt(this.damageNumber);isMobile&&(s+=.1),this.damageNum.setScale(.98*s),this.damageNum.y=this.damageNum.startY+e,this.damageNum.alpha=1;let a=Math.floor(i*i*36),h={targets:this.damageNum,scaleX:s*(1+i),scaleY:s*(1+i),rotation:.075*i*(.5>Math.random()?1:-1),duration:150+a,ease:"Cubic.easeOut",onComplete:()=>{this.damageTween=this.scene.tweens.add({targets:this.damageNum,scaleX:s,scaleY:s,rotation:0,duration:300+a,ease:"Bounce.easeOut",onComplete:()=>{this.damageTween=this.scene.tweens.add({delay:850+Math.floor(this.damageNumber),targets:this.damageNum,scaleX:0,scaleY:0,alpha:0,duration:250,ease:"Quart.easeIn"})}})}};this.damageTween=this.scene.tweens.add(h)}animateTrueDamageNum(t,e,i,s,a,h){let o=this.getTextObjFromArray(t,e,i,this.bonusNums,"bonus");o.depth=9992;let n=isMobile?1.15:1;o.setScale(s*n).setAlpha(1),this.animateNum(o,this.bonusNums,a,h)}animateHealNum(t,e,i,s,a={},h){let o=this.getTextObjFromArray(t,e,i,this.healNums,"heal"),n=isMobile?1.15:1;o.setScale(s*n).setAlpha(1),a.duration=a.duration?a.duration+300:1e3,this.animateNum(o,this.healNums,a,h),this.healVisual||(this.healVisual=this.scene.add.image(t,e+30,"misc","heal.png").setDepth(99999)),this.healVisual.setAlpha(1).setPosition(t,e+15).setScale(Math.sqrt(.8*s)),.5>Math.random()&&(this.healVisual.scaleX*=-1),this.scene.tweens.add({targets:this.healVisual,y:"-=30",duration:1e3}),this.scene.tweens.add({targets:this.healVisual,alpha:0,duration:1e3,ease:"Cubic.easeIn"})}animateBlockNum(t,e,i,s,a,h){let o=this.getTextObjFromArray(t,e,i,this.blockNums,"block"),n=isMobile?1.15:1;o.setScale(s*n).setAlpha(1),this.animateNum(o,this.blockNums,a,h)}animateArmorNum(t,e,i,s,a,h){let o=this.getTextObjFromArray(t,e,i,this.armorNums,"armor"),n=isMobile?1.15:1;o.setScale(s*n).setAlpha(1),this.animateNum(o,this.armorNums,a,h)}animateVoidNum(t,e,i,s,a,h){let o=this.getTextObjFromArray(t,e,i,this.voidNums,"void"),n=isMobile?1.15:1;o.setScale(s*n).setAlpha(1),this.animateNum(o,this.voidNums,a,h)}getTextObjFromArray(t,e,i,s,a="block"){let h=s.pop();return h||((h=this.scene.add.bitmapText(t,e,a,i,32)).setDepth(9981),h.setOrigin(.5,.5),h.setCenterAlign()),h.setPosition(t,e),h.setText(i),h.visible=!0,h}animateNum(t,e,i={},s={}){let a={targets:t,y:"-=18",duration:700,ease:"Cubic.easeOut",onComplete:()=>{let i={targets:t,scaleX:.4*t.scaleX,scaleY:.4*t.scaleY,alpha:0,duration:350,ease:"Quart.easeIn",onComplete(){t.visible=!1,e.push(t)}};i={...i,...s},this.scene.tweens.add(i)}};a={...a,...i},this.scene.tweens.add(a)}}
